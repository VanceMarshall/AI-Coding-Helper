// filepath: public/index.html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <title>AI Code Helper</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <style>
    :root{--bg:#0d1117;--bg2:#161b22;--bg3:#21262d;--bg4:#30363d;--border:#30363d;--text:#e6edf3;--text2:#8b949e;--text3:#6e7681;--accent:#58a6ff;--green:#3fb950;--red:#f85149;--yellow:#d29922;--purple:#a371f7;--sans:'Plus Jakarta Sans',sans-serif;--mono:'JetBrains Mono',monospace}
    *{box-sizing:border-box;margin:0;padding:0}html,body{height:100%;overflow:hidden}
    body{font-family:var(--sans);background:var(--bg);color:var(--text);font-size:14px;line-height:1.5}
    .app{display:flex;height:100vh;height:100dvh}
    .sidebar{width:280px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;z-index:100}
    .sidebar-header{padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .sidebar-header h1{font-size:18px;display:flex;align-items:center;gap:8px}
    .sidebar-header h1 span{background:linear-gradient(135deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .close-sidebar{display:none;background:none;border:none;color:var(--text2);font-size:24px;cursor:pointer;padding:4px}
    .project-select{padding:12px 16px;border-bottom:1px solid var(--border)}
    .project-select label{display:block;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--text2);margin-bottom:6px}
    .project-select select{width:100%;padding:10px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--sans);font-size:14px}
    .sidebar-actions{padding:12px 16px;display:flex;flex-direction:column;gap:8px}
    .action-btn{padding:12px 16px;border:none;border-radius:8px;font-family:var(--sans);font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
    .action-btn.primary{background:var(--accent);color:var(--bg)}
    .action-btn.secondary{background:var(--bg3);color:var(--text);border:1px solid var(--border)}
    .action-btn:hover{opacity:0.9}
    .conversations{flex:1;overflow-y:auto;padding:8px}
    .conv-item{padding:12px;border-radius:8px;cursor:pointer;margin-bottom:4px;display:flex;align-items:center;gap:8px;font-size:14px}
    .conv-item:hover{background:var(--bg4)}.conv-item.active{background:var(--bg3)}
    .conv-item .title{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .conv-item .type-badge{font-size:10px;padding:2px 6px;border-radius:4px;background:var(--bg4);color:var(--text3)}
    .conv-item .type-badge.planning{background:rgba(210,153,34,0.2);color:var(--yellow)}
    .sidebar-footer{padding:12px 16px;border-top:1px solid var(--border)}
    .sidebar-footer a{color:var(--text2);text-decoration:none;font-size:13px;display:flex;align-items:center;gap:6px;padding:8px 0}
    .sidebar-footer a:hover{color:var(--text)}
    .main{flex:1;display:flex;flex-direction:column;min-width:0}
    .chat-header{padding:12px 16px;border-bottom:1px solid var(--border);background:var(--bg2);display:flex;align-items:center;gap:12px}
    .menu-btn{display:none;background:none;border:none;color:var(--text);font-size:20px;cursor:pointer;padding:4px}
    .chat-title{font-size:15px;font-weight:600;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .repo-status{font-size:12px;color:var(--text2);display:flex;align-items:center;gap:6px}
    .repo-status .dot{width:6px;height:6px;border-radius:50%;background:var(--green)}
    .create-repo-btn{font-size:12px;padding:6px 12px;background:var(--accent);color:var(--bg);border:none;border-radius:6px;cursor:pointer;font-weight:500}
    .create-repo-btn:hover{opacity:0.9}
    .model-indicator{font-size:12px;color:var(--text2);display:flex;align-items:center;gap:6px;flex-shrink:0}
    .model-indicator .dot{width:6px;height:6px;border-radius:50%;background:var(--green)}
    .messages{flex:1;overflow-y:auto;padding:16px}.messages-inner{max-width:800px;margin:0 auto}
    .message{margin-bottom:20px;animation:fadeIn .3s}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1}}
    .msg-header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .msg-avatar{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;flex-shrink:0}
    .message.user .msg-avatar{background:var(--accent);color:var(--bg)}
    .message.assistant .msg-avatar{background:linear-gradient(135deg,var(--purple),var(--accent));color:#fff}
    .msg-author{font-weight:600}.msg-meta{font-size:11px;color:var(--text3)}
    .msg-content{padding-left:38px}.msg-content p{margin-bottom:12px}.msg-content p:last-child{margin-bottom:0}
    .msg-content pre{margin:12px 0;border-radius:8px;overflow:hidden}
    .msg-content pre code{display:block;padding:12px;background:var(--bg3);overflow-x:auto;font-size:13px}
    .msg-content code{font-family:var(--mono);background:var(--bg3);padding:2px 6px;border-radius:4px;font-size:13px}
    .msg-content ul,.msg-content ol{margin:12px 0;padding-left:24px}.msg-content li{margin-bottom:6px}
    .msg-content h2,.msg-content h3{margin:16px 0 8px;color:var(--text)}
    .msg-content strong{color:var(--text)}
    .msg-content hr{border:none;border-top:1px solid var(--border);margin:16px 0}
    .code-header{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--bg4);font-size:12px;color:var(--text2);flex-wrap:wrap;gap:8px}
    .code-header .code-lang{font-weight:500}
    .code-header .code-actions{display:flex;gap:6px}
    .code-header button{background:none;border:1px solid var(--border);color:var(--text2);cursor:pointer;font-size:11px;padding:6px 10px;border-radius:4px;font-family:var(--sans)}
    .code-header button:hover{background:var(--bg3);color:var(--text);border-color:var(--text3)}
    .code-header button.apply-btn{border-color:var(--green);color:var(--green)}
    .code-header button.apply-btn:hover{background:rgba(63,185,80,0.15)}
    .code-header button.applied{border-color:var(--green);background:rgba(63,185,80,0.15);color:var(--green)}
    .code-header button:disabled{opacity:0.5;cursor:not-allowed}
    .code-summary{margin-top:16px;padding:16px;background:var(--bg2);border:1px solid var(--border);border-radius:8px}
    .code-summary h4{font-size:14px;margin-bottom:12px;color:var(--text);display:flex;align-items:center;gap:8px}
    .code-files{display:flex;flex-direction:column;gap:8px}
    .code-file-item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--bg3);border-radius:6px;font-size:13px}
    .code-file-name{font-family:var(--mono);flex:1}
    .code-file-actions{display:flex;gap:6px}
    .code-file-actions button{padding:6px 12px;border:1px solid var(--border);background:var(--bg4);color:var(--text2);border-radius:4px;font-size:11px;cursor:pointer}
    .code-file-actions button:hover{background:var(--bg3);color:var(--text)}
    .code-file-actions button.apply{border-color:var(--green);color:var(--green)}
    .code-file-actions button.apply:hover{background:rgba(63,185,80,0.15)}
    .code-file-actions button.applied{background:rgba(63,185,80,0.15);color:var(--green)}
    .apply-all-btn{margin-top:10px;padding:10px 16px;background:var(--accent);color:var(--bg);border:none;border-radius:6px;font-weight:600;cursor:pointer;width:100%}
    .apply-all-btn:hover{opacity:0.9}
    .apply-all-btn:disabled{opacity:0.5;cursor:not-allowed}
    .repo-suggestion{margin-top:16px;padding:16px;background:rgba(88,166,255,0.1);border:1px solid rgba(88,166,255,0.3);border-radius:8px}
    .repo-suggestion h4{color:var(--accent);margin-bottom:8px;font-size:14px}
    .repo-suggestion p{color:var(--text2);margin-bottom:12px;font-size:13px}
    .repo-suggestion button{padding:8px 16px;background:var(--accent);color:var(--bg);border:none;border-radius:6px;font-weight:600;cursor:pointer}
    .empty-state{text-align:center;padding:40px 20px;color:var(--text2)}
    .empty-state h2{font-size:22px;color:var(--text);margin-bottom:8px}
    .empty-state p{margin-bottom:20px;max-width:400px;margin-left:auto;margin-right:auto}
    .empty-actions{display:flex;flex-direction:column;align-items:center;gap:10px;margin-bottom:24px}
    .empty-actions button{padding:14px 28px;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;width:100%;max-width:260px;justify-content:center}
    .empty-actions .primary{background:var(--accent);color:var(--bg);border:none}
    .empty-actions .secondary{background:var(--bg3);color:var(--text);border:1px solid var(--border)}
    .suggestions{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin-top:20px}
    .suggestion{padding:10px 16px;background:var(--bg3);border:1px solid var(--border);border-radius:20px;font-size:14px;cursor:pointer;color:var(--text)}
    .suggestion:hover{border-color:var(--accent);color:var(--accent)}
    .input-area{padding:12px 16px;border-top:1px solid var(--border);background:var(--bg2)}
    .input-inner{max-width:800px;margin:0 auto}
    .mode-indicator{display:flex;align-items:center;gap:8px;margin-bottom:10px;font-size:12px;color:var(--text2)}
    .mode-indicator .mode-badge{padding:4px 10px;border-radius:12px;font-weight:500}
    .mode-indicator .mode-badge.planning{background:rgba(210,153,34,0.2);color:var(--yellow)}
    .mode-indicator .mode-badge.building{background:rgba(88,166,255,0.2);color:var(--accent)}
    .model-toggle{display:flex;gap:4px;margin-bottom:10px;background:var(--bg3);padding:4px;border-radius:8px;width:fit-content}
    .model-toggle button{padding:8px 14px;background:none;border:none;color:var(--text2);font-family:var(--sans);font-size:13px;font-weight:500;cursor:pointer;border-radius:6px}
    .model-toggle button.active{background:var(--bg4);color:var(--text)}
    .model-toggle button.active[data-mode=auto]{color:var(--yellow)}
    .model-toggle button.active[data-mode=fast]{color:var(--green)}
    .model-toggle button.active[data-mode=full]{color:var(--accent)}
    .route-preview{font-size:11px;color:var(--text3);margin-bottom:8px;min-height:16px}
    .file-chips{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px}
    .file-chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;background:var(--bg3);border:1px solid var(--border);border-radius:16px;font-size:12px;font-family:var(--mono)}
    .file-chip button{background:none;border:none;color:var(--text3);cursor:pointer;font-size:14px;padding:0 2px}
    .file-chip button:hover{color:var(--red)}
    .input-box{position:relative}
    .input-box textarea{width:100%;padding:14px 16px;padding-right:90px;background:var(--bg3);border:1px solid var(--border);border-radius:12px;color:var(--text);font-family:var(--sans);font-size:15px;resize:none;min-height:52px;max-height:150px}
    .input-box textarea:focus{outline:none;border-color:var(--accent)}
    .input-box textarea::placeholder{color:var(--text3)}
    .input-actions{position:absolute;right:8px;bottom:8px;display:flex;gap:6px}
    .input-actions button{padding:10px 16px;background:var(--accent);border:none;border-radius:6px;color:var(--bg);font-weight:600;cursor:pointer;font-size:14px}
    .input-actions button:disabled{opacity:.5;cursor:not-allowed}
    .input-actions button.attach{background:transparent;color:var(--text2);padding:10px}
    .input-hint{margin-top:8px;font-size:11px;color:var(--text3);text-align:center}
    .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000;padding:16px}
    .modal.active{display:flex}
    .modal-content{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:20px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto}
    .modal h3{margin-bottom:16px;font-size:17px}
    .form-group{margin-bottom:16px}
    .form-group label{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
    .form-group input,.form-group select{width:100%;padding:10px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px}
    .form-group input:focus,.form-group select:focus{outline:none;border-color:var(--accent)}
    .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px}
    .modal-actions button{padding:10px 20px;border-radius:6px;font-weight:600;cursor:pointer;font-size:14px}
    .modal-actions .primary{background:var(--accent);color:var(--bg);border:none}
    .modal-actions .secondary{background:var(--bg3);color:var(--text);border:1px solid var(--border)}
    @media(max-width:768px){
      .sidebar{position:fixed;left:-280px;transition:left .3s;z-index:200}
      .sidebar.open{left:0}
      .menu-btn,.close-sidebar{display:block}
      .chat-header{padding-left:50px}
      .project-select,.sidebar-actions{padding:12px}
    }
    .hidden{display:none!important}
    .toast{position:fixed;bottom:20px;right:20px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:12px 16px;font-size:13px;max-width:300px;z-index:1000;display:none}
    .toast.success{border-left:3px solid var(--green)}
    .toast.error{border-left:3px solid var(--red)}
    .toast.show{display:block;animation:slideIn .3s}
    @keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}
  </style>
</head>
<body>
  <div class="app">
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h1>ü§ñ <span>AI Code Helper</span></h1>
        <button class="close-sidebar" onclick="toggleSidebar()">√ó</button>
      </div>
      
      <div class="project-select">
        <label>Active Project</label>
        <select id="projectSelect">
          <option value="">Select a repository...</option>
        </select>
      </div>
      
      <div class="sidebar-actions">
        <button class="action-btn primary" onclick="newChat('planning')">üí° New Project</button>
        <button class="action-btn secondary" onclick="newChat('general')">üí¨ General Chat</button>
      </div>
      
      <div class="conversations" id="conversations"></div>
      
      <div class="sidebar-footer">
        <a href="/admin.html" target="_blank">‚öôÔ∏è Admin Panel</a>
      </div>
    </div>
    
    <div class="main">
      <div class="chat-header">
        <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
        <div class="chat-title" id="chatTitle">AI Code Helper</div>
        <div class="repo-status" id="repoStatus"></div>
        <button class="create-repo-btn hidden" id="createRepoBtn" onclick="showCreateRepoModal()">+ Create Repo</button>
      </div>
      
      <div class="messages" id="messages">
        <div class="messages-inner">
          <div class="empty-state">
            <h2>ü§ñ Ready to code!</h2>
            <p>Start a new project to brainstorm ideas and build applications, or have a general chat about coding.</p>
            <div class="empty-actions">
              <button class="primary" onclick="newChat('planning')">üí° Start New Project</button>
              <button class="secondary" onclick="newChat('general')">üí¨ General Chat</button>
            </div>
            <div class="suggestions">
              <div class="suggestion" onclick="sendMessage('Build a task management app with React and Node.js')">Task Manager App</div>
              <div class="suggestion" onclick="sendMessage('Create a weather dashboard with API integration')">Weather Dashboard</div>
              <div class="suggestion" onclick="sendMessage('Help me build a blog with Next.js')">Next.js Blog</div>
              <div class="suggestion" onclick="sendMessage('Design a REST API for an e-commerce platform')">E-commerce API</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="input-area">
        <div class="input-inner">
          <div class="mode-indicator" id="modeIndicator"></div>
          
          <div class="model-toggle">
            <button data-mode="auto" class="active" onclick="setModelMode('auto')">üéØ Smart</button>
            <button data-mode="fast" onclick="setModelMode('fast')">‚ö° Fast</button>
            <button data-mode="full" onclick="setModelMode('full')">üß† Full</button>
          </div>
          
          <div class="route-preview" id="routePreview"></div>
          <div class="file-chips" id="fileChips"></div>
          
          <div class="input-box">
            <textarea id="messageInput" placeholder="Ask anything about coding, or describe your project idea..." rows="1"></textarea>
            <div class="input-actions">
              <button class="attach" onclick="showFileSelector()" title="Load files">üìé</button>
              <button id="sendBtn" onclick="sendMessage()">Send</button>
            </div>
          </div>
          
          <div class="input-hint">Press Enter to send, Shift+Enter for new line</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Repository Modal -->
  <div class="modal" id="createRepoModal">
    <div class="modal-content">
      <h3>üöÄ Create GitHub Repository</h3>
      <form id="createRepoForm">
        <div class="form-group">
          <label for="repoName">Repository Name</label>
          <input type="text" id="repoName" required>
        </div>
        <div class="form-group">
          <label for="repoDescription">Description</label>
          <input type="text" id="repoDescription">
        </div>
        <div class="form-group">
          <label for="repoPrivacy">Privacy</label>
          <select id="repoPrivacy">
            <option value="private">Private</option>
            <option value="public">Public</option>
          </select>
        </div>
        <div class="modal-actions">
          <button type="button" class="secondary" onclick="closeModal()">Cancel</button>
          <button type="submit" class="primary">Create Repository</button>
        </div>
      </form>
    </div>
  </div>

  <!-- File Selector Modal -->
  <div class="modal" id="fileModal">
    <div class="modal-content">
      <h3>üìÇ Load Project Files</h3>
      <div id="fileList"></div>
      <div class="modal-actions">
        <button class="secondary" onclick="closeModal()">Cancel</button>
        <button class="primary" onclick="loadSelectedFiles()">Load Files</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    let currentConversation = null;
    let conversations = [];
    let repositories = [];
    let loadedFiles = [];
    let modelMode = 'auto';
    let isStreaming = false;

    const messageInput = document.getElementById('messageInput');
    const messagesEl = document.getElementById('messages');
    const conversationsEl = document.getElementById('conversations');
    const projectSelect = document.getElementById('projectSelect');
    const chatTitle = document.getElementById('chatTitle');
    const repoStatus = document.getElementById('repoStatus');
    const createRepoBtn = document.getElementById('createRepoBtn');
    const createRepoModal = document.getElementById('createRepoModal');
    const createRepoForm = document.getElementById('createRepoForm');
    const fileModal = document.getElementById('fileModal');
    const toast = document.getElementById('toast');

    const showToast = (message, type = 'success') => {
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    };

    const showModal = (modalId) => {
      document.getElementById(modalId).classList.add('active');
    };

    const closeModal = () => {
      document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
    };

    const toggleSidebar = () => {
      document.getElementById('sidebar').classList.toggle('open');
    };

    const setModelMode = (mode) => {
      modelMode = mode;
      document.querySelectorAll('.model-toggle button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });
      updateRoutePreview();
    };

    const updateRoutePreview = async () => {
      if (!messageInput.value.trim()) {
        document.getElementById('routePreview').textContent = '';
        return;
      }

      if (modelMode === 'auto') {
        try {
          const response = await fetch(`/api/route-preview?message=${encodeURIComponent(messageInput.value)}&hasFiles=${loadedFiles.length > 0}`);
          const preview = await response.json();
          document.getElementById('routePreview').textContent = `‚Üí ${preview.modelName} (${preview.reason})`;
        } catch (err) {
          console.error('Route preview error:', err);
        }
      } else {
        document.getElementById('routePreview').textContent = `‚Üí ${modelMode.charAt(0).toUpperCase() + modelMode.slice(1)} model (manual)`;
      }
    };

    const loadRepositories = async () => {
      try {
        const response = await fetch('/api/repos');
        repositories = await response.json();
        projectSelect.innerHTML = '<option value="">Select a repository...</option>';
        repositories.forEach(repo => {
          const option = document.createElement('option');
          option.value = repo.fullName;
          option.textContent = repo.fullName;
          projectSelect.appendChild(option);
        });
      } catch (err) {
        console.error('Load repos error:', err);
      }
    };

    const loadConversations = async () => {
      try {
        const response = await fetch('/api/conversations');
        conversations = await response.json();
        renderConversations();
      } catch (err) {
        console.error('Load conversations error:', err);
      }
    };

    const renderConversations = () => {
      conversationsEl.innerHTML = conversations.map(conv => `
        <div class="conv-item ${conv.id === currentConversation?.id ? 'active' : ''}" onclick="loadConversation('${conv.id}')">
          <div class="title">${conv.title}</div>
          <div class="type-badge ${conv.type}">${conv.type}</div>
        </div>
      `).join('');
    };

    const newChat = async (type = 'general') => {
      try {
        const response = await fetch('/api/conversations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            title: type === 'planning' ? 'New Project' : 'New Chat',
            type 
          })
        });
        const conversation = await response.json();
        conversations.unshift(conversation);
        loadConversation(conversation.id);
        renderConversations();
      } catch (err) {
        console.error('New chat error:', err);
        showToast('Failed to create new chat', 'error');
      }
    };

    const loadConversation = async (id) => {
      try {
        const response = await fetch(`/api/conversations/${id}`);
        currentConversation = await response.json();
        renderMessages();
        updateChatHeader();
        renderConversations();
      } catch (err) {
        console.error('Load conversation error:', err);
        showToast('Failed to load conversation', 'error');
      }
    };

    const updateChatHeader = () => {
      chatTitle.textContent = currentConversation?.title || 'AI Code Helper';
      
      const modeIndicator = document.getElementById('modeIndicator');
      if (currentConversation?.type === 'planning') {
        modeIndicator.innerHTML = '<div class="mode-badge planning">üí° Project Planning</div>';
        
        // Show create repo button if no repo is associated and this is a planning chat
        if (!currentConversation.repoFullName) {
          createRepoBtn.classList.remove('hidden');
        } else {
          createRepoBtn.classList.add('hidden');
        }
      } else {
        modeIndicator.innerHTML = '<div class="mode-badge building">üí¨ General Chat</div>';
        createRepoBtn.classList.add('hidden');
      }
      
      // Update repo status
      if (currentConversation?.repoFullName) {
        repoStatus.innerHTML = `<span class="dot"></span> ${currentConversation.repoFullName}`;
        projectSelect.value = currentConversation.repoFullName;
      } else {
        repoStatus.innerHTML = '';
        projectSelect.value = '';
      }
      
      // Update loaded files
      loadedFiles = currentConversation?.loadedFiles || [];
      renderFileChips();
    };

    const renderMessages = () => {
      if (!currentConversation || currentConversation.messages.length === 0) {
        messagesEl.innerHTML = '<div class="messages-inner"><div class="empty-state"><h2>ü§ñ Ready to code!</h2><p>Start asking questions or describing your project ideas.</p></div></div>';
        return;
      }

      const messagesHtml = currentConversation.messages.map(msg => {
        let content = marked.parse(msg.content);
        
        // Add code headers and apply buttons
        content = content.replace(/<pre><code class="language-(\w+)">/g, (match, lang) => {
          return `<div class="code-header"><span class="code-lang">${lang}</span><div class="code-actions"><button onclick="copyCode(this)">Copy</button></div></div><pre><code class="language-${lang}">`;
        });

        // Look for filepath comments and add apply buttons
        content = content.replace(/\/\/ filepath: ([^\n]+)/g, (match, filepath) => {
          const codeId = 'code_' + Math.random().toString(36).substr(2, 9);
          return `${match}<button class="apply-btn" onclick="applyCode('${codeId}', '${filepath}')">Apply</button></div><div id="${codeId}">`;
        });

        let messageHtml = `
          <div class="message ${msg.role}">
            <div class="msg-header">
              <div class="msg-avatar">${msg.role === 'user' ? 'You' : 'AI'}</div>
              <div class="msg-author">${msg.role === 'user' ? 'You' : 'Assistant'}</div>
              <div class="msg-meta">${new Date(msg.timestamp).toLocaleTimeString()}</div>
            </div>
            <div class="msg-content">${content}</div>
          </div>
        `;

        // Add code summary if this message has code blocks
        if (msg.codeBlocks && msg.codeBlocks.length > 0) {
          const codeSummaryHtml = `
            <div class="code-summary">
              <h4>üìù Code Files Generated (${msg.codeBlocks.length})</h4>
              <div class="code-files">
                ${msg.codeBlocks.map(block => `
                  <div class="code-file-item">
                    <span class="code-file-name">${block.filepath}</span>
                    <div class="code-file-actions">
                      <button onclick="jumpToCode('${block.id}')">View</button>
                      <button class="apply" onclick="applyCodeFromSummary('${block.id}', '${block.filepath}', \`${block.code.replace(/`/g, '\\`')}\`)">Apply</button>
                    </div>
                  </div>
                `).join('')}
              </div>
              <button class="apply-all-btn" onclick="applyAllCode('${msg.timestamp}')">Apply All Files</button>
            </div>
          `;
          messageHtml += codeSummaryHtml;
        }

        return messageHtml;
      }).join('');

      messagesEl.innerHTML = `<div class="messages-inner">${messagesHtml}</div>`;
      messagesEl.scrollTop = messagesEl.scrollHeight;

      // Highlight code blocks
      document.querySelectorAll('pre code').forEach(el => {
        hljs.highlightElement(el);
      });
    };

    const sendMessage = async (text = null) => {
      if (isStreaming) return;
      
      const message = text || messageInput.value.trim();
      if (!message) return;
      
      if (!currentConversation) {
        await newChat('general');
      }
      
      messageInput.value = '';
      messageInput.style.height = 'auto';
      isStreaming = true;
      document.getElementById('sendBtn').disabled = true;

      // Add user message to UI
      const userMessage = {
        role: 'user',
        content: message,
        timestamp: Date.now()
      };
      currentConversation.messages.push(userMessage);
      
      // Start AI response
      const assistantMessage = {
        role: 'assistant',
        content: '',
        timestamp: Date.now(),
        codeBlocks: []
      };
      currentConversation.messages.push(assistantMessage);
      renderMessages();

      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message,
            conversationId: currentConversation.id,
            projectRepo: projectSelect.value || null,
            loadedFiles,
            modelMode
          })
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value, { stream: true });
          const lines = chunk.split('\n').filter(line => line.trim());

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.slice(6));
                
                if (data.error) {
                  showToast('Error: ' + data.error, 'error');
                  break;
                }
                
                if (data.type === 'text') {
                  assistantMessage.content += data.text;
                  renderMessages();
                } else if (data.type === 'done') {
                  assistantMessage.codeBlocks = data.codeBlocks || [];
                  
                  // Show repository suggestion if appropriate
                  if (data.shouldSuggestRepo) {
                    showRepoSuggestion();
                  }
                  
                  renderMessages();
                  showToast(`Response complete ‚Ä¢ ${data.model} ‚Ä¢ $${data.cost}`);
                }
              } catch (err) {
                console.error('Parse error:', err);
              }
            }
          }
        }
      } catch (err) {
        console.error('Chat error:', err);
        showToast('Failed to send message', 'error');
      } finally {
        isStreaming = false;
        document.getElementById('sendBtn').disabled = false;
      }
    };

    const showRepoSuggestion = () => {
      const suggestion = document.createElement('div');
      suggestion.className = 'repo-suggestion';
      suggestion.innerHTML = `
        <h4>üöÄ Ready to start building?</h4>
        <p>Create a GitHub repository for this project to start applying code changes.</p>
        <button onclick="showCreateRepoModal(); this.parentElement.remove()">Create Repository</button>
      `;
      
      const messagesInner = document.querySelector('.messages-inner');
      messagesInner.appendChild(suggestion);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    };

    const showCreateRepoModal = () => {
      // Pre-fill repo name based on conversation context
      if (currentConversation) {
        const repoName = document.getElementById('repoName');
        const titleWords = currentConversation.title.toLowerCase().split(' ').filter(w => w.length > 2);
        if (titleWords.length > 0) {
          repoName.value = titleWords.join('-').replace(/[^a-z0-9-]/g, '');
        }
      }
      
      showModal('createRepoModal');
    };

    const applyCode = async (codeId, filepath) => {
      if (!projectSelect.value) {
        showToast('Please select a repository first', 'error');
        return;
      }

      const codeElement = document.getElementById(codeId);
      if (!codeElement) return;

      const code = codeElement.querySelector('code').textContent;
      
      try {
        const [owner, repo] = projectSelect.value.split('/');
        const response = await fetch(`/api/repos/${owner}/${repo}/create-file`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            filePath: filepath,
            content: code,
            message: `Update ${filepath} via AI Code Helper`
          })
        });

        if (response.ok) {
          showToast(`Applied to ${filepath}`);
          // Mark as applied
          const applyBtn = codeElement.parentElement.querySelector('.apply-btn');
          if (applyBtn) {
            applyBtn.textContent = 'Applied ‚úì';
            applyBtn.classList.add('applied');
            applyBtn.disabled = true;
          }
        } else {
          const error = await response.json();
          showToast(`Failed to apply: ${error.error}`, 'error');
        }
      } catch (err) {
        console.error('Apply code error:', err);
        showToast('Failed to apply code', 'error');
      }
    };

    const applyCodeFromSummary = async (blockId, filepath, code) => {
      if (!projectSelect.value) {
        showToast('Please select a repository first', 'error');
        return;
      }

      try {
        const [owner, repo] = projectSelect.value.split('/');
        const response = await fetch(`/api/repos/${owner}/${repo}/create-file`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            filePath: filepath,
            content: code,
            message: `Update ${filepath} via AI Code Helper`
          })
        });

        if (response.ok) {
          showToast(`Applied to ${filepath}`);
          // Mark as applied
          const applyBtn = document.querySelector(`button[onclick*="${blockId}"][onclick*="applyCodeFromSummary"]`);
          if (applyBtn) {
            applyBtn.textContent = 'Applied ‚úì';
            applyBtn.classList.add('applied');
            applyBtn.disabled = true;
          }
        } else {
          const error = await response.json();
          showToast(`Failed to apply: ${error.error}`, 'error');
        }
      } catch (err) {
        console.error('Apply code error:', err);
        showToast('Failed to apply code', 'error');
      }
    };

    const applyAllCode = async (messageTimestamp) => {
      if (!projectSelect.value) {
        showToast('Please select a repository first', 'error');
        return;
      }

      const message = currentConversation.messages.find(m => m.timestamp == messageTimestamp);
      if (!message || !message.codeBlocks) return;

      const applyAllBtn = document.querySelector(`button[onclick*="${messageTimestamp}"]`);
      applyAllBtn.disabled = true;
      applyAllBtn.textContent = 'Applying...';

      let successCount = 0;
      let totalCount = message.codeBlocks.length;

      for (const block of message.codeBlocks) {
        try {
          const [owner, repo] = projectSelect.value.split('/');
          const response = await fetch(`/api/repos/${owner}/${repo}/create-file`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              filePath: block.filepath,
              content: block.code,
              message: `Update ${block.filepath} via AI Code Helper`
            })
          });

          if (response.ok) {
            successCount++;
            // Mark individual file as applied
            const fileApplyBtn = document.querySelector(`button[onclick*="${block.id}"][onclick*="applyCodeFromSummary"]`);
            if (fileApplyBtn) {
              fileApplyBtn.textContent = 'Applied ‚úì';
              fileApplyBtn.classList.add('applied');
              fileApplyBtn.disabled = true;
            }
          }
        } catch (err) {
          console.error('Apply error:', err);
        }
        
        // Small delay between applications
        await new Promise(resolve => setTimeout(resolve, 500));
      }

      applyAllBtn.textContent = `Applied ${successCount}/${totalCount}`;
      showToast(`Applied ${successCount} of ${totalCount} files`);
    };

    const jumpToCode = (blockId) => {
      // Find the code block in the current page and scroll to it
      const codeElement = document.getElementById(blockId);
      if (codeElement) {
        codeElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        codeElement.style.border = '2px solid var(--accent)';
        setTimeout(() => {
          codeElement.style.border = '';
        }, 2000);
      }
    };

    const copyCode = (btn) => {
      const code = btn.closest('.code-header').nextElementSibling.querySelector('code');
      navigator.clipboard.writeText(code.textContent).then(() => {
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = 'Copy', 2000);
      });
    };

    const renderFileChips = () => {
      const fileChips = document.getElementById('fileChips');
      fileChips.innerHTML = loadedFiles.map(file => `
        <div class="file-chip">
          ${file.path}
          <button onclick="removeFile('${file.path}')" title="Remove file">√ó</button>
        </div>
      `).join('');
    };

    // Event listeners
    createRepoForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(createRepoForm);
      const repoData = {
        name: formData.get('repoName'),
        description: formData.get('repoDescription'),
        private: formData.get('repoPrivacy') === 'private',
        conversationId: currentConversation?.id
      };

      try {
        const response = await fetch('/api/create-repo-from-chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(repoData)
        });

        const repo = await response.json();
        
        if (response.ok) {
          showToast(`Repository "${repo.name}" created successfully!`);
          
          // Update current conversation
          if (currentConversation) {
            currentConversation.repoFullName = repo.full_name;
          }
          
          // Refresh repositories and update UI
          await loadRepositories();
          updateChatHeader();
          closeModal();
        } else {
          showToast(`Error: ${repo.error}`, 'error');
        }
      } catch (err) {
        console.error('Create repo error:', err);
        showToast('Failed to create repository', 'error');
      }
    });

    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    messageInput.addEventListener('input', () => {
      messageInput.style.height = 'auto';
      messageInput.style.height = messageInput.scrollHeight + 'px';
      updateRoutePreview();
    });

    projectSelect.addEventListener('change', () => {
      if (currentConversation) {
        currentConversation.repoFullName = projectSelect.value || null;
        updateChatHeader();
      }
    });

    // Initialize
    loadRepositories();
    loadConversations();
  </script>
</body>
</html>
