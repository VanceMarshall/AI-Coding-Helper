<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Admin - AI Code Helper</title>
  <style>
    :root{--bg:#0d1117;--text:#e6edf3;--muted:#9da7b3;--brand:#58a6ff;--danger:#ff6b6b;--ok:#3fb950;--border:rgba(255,255,255,.08)}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:radial-gradient(1200px 900px at 20% 0%,rgba(88,166,255,.12),transparent 60%),radial-gradient(900px 700px at 85% 15%,rgba(63,185,80,.10),transparent 55%),#0d1117;min-height:100vh}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 10px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    input,select,textarea{width:100%;background:rgba(0,0,0,.25);border:1px solid var(--border);border-radius:12px;color:var(--text);padding:10px 12px;outline:none}
    textarea{min-height:120px;resize:vertical}
    .btn{background:rgba(88,166,255,.18);border:1px solid rgba(88,166,255,.35);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn:hover{filter:brightness(1.08)}
    .btn.danger{background:rgba(255,107,107,.14);border-color:rgba(255,107,107,.35)}
    .pill{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:rgba(0,0,0,.2);color:var(--muted);font-size:12px}
    .muted{color:var(--muted)}
    .err{color:var(--danger);font-size:12px;margin-top:8px;white-space:pre-wrap}
    .ok{color:var(--ok);font-size:12px;margin-top:8px}
    .hidden{display:none}
    .kvs{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){.kvs{grid-template-columns:1fr}}
    .kv{background:rgba(0,0,0,.18);border:1px solid var(--border);border-radius:12px;padding:10px}
    .kv .k{font-size:12px;color:var(--muted)}
    .kv .v{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;margin-top:4px;word-break:break-all}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between;margin-bottom:12px">
      <div>
        <h1>Admin Panel</h1>
        <div class="muted">Model routing, guardrails, and key visibility. Keys are never displayed in full.</div>
      </div>
      <div class="row">
        <span id="authPill" class="pill">Auth: <span id="authState">checking…</span></span>
        <button class="btn" id="logoutBtn">Logout</button>
      </div>
    </div>

    <div id="loginCard" class="card">
      <h2 style="margin:0 0 8px;font-size:16px">Login</h2>
      <div class="muted">Enter your admin password.</div>
      <label>Password</label>
      <input id="pw" type="password" placeholder="••••••••">
      <div class="row" style="margin-top:10px">
        <button class="btn" id="loginBtn">Login</button>
        <button class="btn" id="setPwBtn">Set/Reset Password</button>
      </div>
      <div id="loginErr" class="err hidden"></div>
      <div id="loginOk" class="ok hidden"></div>
      <div class="muted" style="margin-top:10px">Tip: set <code>ADMIN_SESSION_SECRET</code> in Railway for stable sessions.</div>
    </div>

    <div id="main" class="grid hidden" style="margin-top:16px">
      <div class="card">
        <h2 style="margin:0 0 8px;font-size:16px">Quick Stats</h2>
        <div class="kvs">
          <div class="kv"><div class="k">Total Messages</div><div id="statMsg" class="v">-</div></div>
          <div class="kv"><div class="k">Total Cost (USD)</div><div id="statCost" class="v">-</div></div>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn danger" id="resetStatsBtn">Reset Stats</button>
        </div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 8px;font-size:16px">API Keys</h2>
        <div class="muted">Shows whether Railway env vars are set (masked).</div>
        <div id="keysBox" class="kvs" style="margin-top:10px"></div>
        <div id="keysErr" class="err hidden"></div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 8px;font-size:16px">Model Routing</h2>
        <div class="muted">Choose models for fast / full / fallback. Sync only adds options.</div>
        <label>Fast Model</label>
        <select id="fastModel"></select>
        <label>Full Model</label>
        <select id="fullModel"></select>
        <label>Fallback Model</label>
        <select id="fallbackModel"></select>
        <div class="row" style="margin-top:12px">
          <button class="btn" id="saveRoutingBtn">Save</button>
          <button class="btn" id="syncModelsBtn">Sync Model Options</button>
        </div>
        <div id="routingOk" class="ok hidden"></div>
        <div id="routingErr" class="err hidden"></div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 8px;font-size:16px">System Prompt</h2>
        <label>Prompt</label>
        <textarea id="sysPrompt" placeholder="Optional system prompt..."></textarea>
        <div class="row" style="margin-top:12px">
          <button class="btn" id="savePromptBtn">Save</button>
        </div>
        <div id="promptOk" class="ok hidden"></div>
        <div id="promptErr" class="err hidden"></div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 8px;font-size:16px">Cost Guardrails</h2>
        <label>Max Cost Per Request (USD)</label>
        <input id="maxCost" type="number" step="0.01" placeholder="e.g. 0.25">
        <label>Max Tokens Per Request</label>
        <input id="maxTokens" type="number" step="1" placeholder="e.g. 4000">
        <div class="row" style="margin-top:12px">
          <button class="btn" id="saveGuardBtn">Save</button>
        </div>
        <div id="guardOk" class="ok hidden"></div>
        <div id="guardErr" class="err hidden"></div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 8px;font-size:16px">Debug</h2>
        <div class="kvs" style="margin-top:10px">
          <div class="kv"><div class="k">Session Token (localStorage)</div><div id="tok" class="v">-</div></div>
          <div class="kv"><div class="k">Auth Status</div><div id="authJson" class="v">-</div></div>
        </div>
      </div>
    </div>
  </div>

<script>
let sessionToken = localStorage.getItem("adminSession") || "";

function authHeaders(){
  return sessionToken ? { "X-Admin-Session": sessionToken } : {};
}
function show(el, on){ el.classList.toggle("hidden", !on); }
function setText(id, t){ document.getElementById(id).textContent = t; }
function setErr(id, msg){
  const el=document.getElementById(id);
  if(!msg){ el.textContent=""; show(el,false); return; }
  el.textContent=msg; show(el,true);
}
function setOk(id, msg){
  const el=document.getElementById(id);
  if(!msg){ el.textContent=""; show(el,false); return; }
  el.textContent=msg; show(el,true);
}

async function apiGet(url){
  const r = await fetch(url, { headers: { ...authHeaders() } });
  if(!r.ok){
    const t = await r.text();
    throw new Error(`${r.status} ${r.statusText}: ${t}`);
  }
  return r.json();
}
async function apiPost(url, body){
  const r = await fetch(url, {
    method:"POST",
    headers: { "Content-Type":"application/json", ...authHeaders() },
    body: JSON.stringify(body || {})
  });
  if(!r.ok){
    const t = await r.text();
    throw new Error(`${r.status} ${r.statusText}: ${t}`);
  }
  return r.json();
}

async function refreshAuth(){
  try{
    const data = await apiGet("/api/admin/auth-status");
    setText("authState", data.isAuthenticated ? "ok" : "not logged in");
    setText("tok", sessionToken ? sessionToken.slice(0,24)+"…" : "(none)");
    setText("authJson", JSON.stringify(data, null, 2));
    show(document.getElementById("loginCard"), !data.isAuthenticated);
    show(document.getElementById("main"), !!data.isAuthenticated);
    return !!data.isAuthenticated;
  }catch(e){
    setText("authState","error");
    setText("authJson", String(e.message||e));
    show(document.getElementById("loginCard"), true);
    show(document.getElementById("main"), false);
    return false;
  }
}

async function login(){
  setErr("loginErr",""); setOk("loginOk","");
  const pw=document.getElementById("pw").value;
  try{
    const d = await apiPost("/api/admin/login", { password: pw });
    // Accept either field (backend returns both)
    sessionToken = d.sessionToken || d.token || "";
    if(!sessionToken) throw new Error("Login succeeded but no token returned.");
    localStorage.setItem("adminSession", sessionToken);
    setOk("loginOk","Logged in.");
    await loadAll();
  }catch(e){
    setErr("loginErr", String(e.message||e));
  }
}

async function setPassword(){
  setErr("loginErr",""); setOk("loginOk","");
  const pw=document.getElementById("pw").value;
  try{
    await apiPost("/api/admin/set-password", { password: pw });
    setOk("loginOk","Password set. Now click Login.");
  }catch(e){
    setErr("loginErr", String(e.message||e));
  }
}

function logout(){
  sessionToken="";
  localStorage.removeItem("adminSession");
  refreshAuth();
}

function fillModelSelect(sel, options, selected){
  sel.innerHTML="";
  const opt0=document.createElement("option");
  opt0.value=""; opt0.textContent="(select)";
  sel.appendChild(opt0);
  for(const o of options){
    const op=document.createElement("option");
    op.value=o.id;
    op.textContent=`${o.displayName || o.id} (${o.provider})`;
    if(o.id===selected) op.selected=true;
    sel.appendChild(op);
  }
}

let cachedConfig=null;

async function loadStats(){
  const st = await apiGet("/api/stats");
  setText("statMsg", st.totalMessages ?? "-");
  setText("statCost", (st.totalCostUSD ?? 0).toFixed(4));
}

async function loadKeys(){
  setErr("keysErr","");
  const box=document.getElementById("keysBox");
  box.innerHTML="";
  const d = await apiGet("/api/admin/api-keys");
  const k = d.keys || {};
  const items = [
    ["OpenAI", k.openai || "(not set)"],
    ["Anthropic", k.anthropic || "(not set)"],
    ["Google", k.google || "(not set)"],
    ["GitHub", k.github || "(not set)"]
  ];
  for(const [name,val] of items){
    const div=document.createElement("div");
    div.className="kv";
    div.innerHTML=`<div class="k">${name}</div><div class="v">${val}</div>`;
    box.appendChild(div);
  }
}

async function loadConfig(){
  cachedConfig = await apiGet("/api/config");
  document.getElementById("sysPrompt").value = cachedConfig.systemPrompt || "";
  document.getElementById("maxCost").value = cachedConfig.guardrails?.maxCostPerRequestUSD ?? "";
  document.getElementById("maxTokens").value = cachedConfig.guardrails?.maxTokensPerRequest ?? "";
}

async function loadModelOptions(){
  const cachedModels = await apiGet("/api/model-options");
  const options = cachedModels.options || [];
  const routing = cachedConfig?.modelRouting || {fast:"",full:"",fallback:""};
  fillModelSelect(document.getElementById("fastModel"), options, routing.fast);
  fillModelSelect(document.getElementById("fullModel"), options, routing.full);
  fillModelSelect(document.getElementById("fallbackModel"), options, routing.fallback);
}

async function saveRouting(){
  setErr("routingErr",""); setOk("routingOk","");
  try{
    const payload = {
      modelRouting: {
        fast: document.getElementById("fastModel").value,
        full: document.getElementById("fullModel").value,
        fallback: document.getElementById("fallbackModel").value
      }
    };
    await apiPost("/api/admin/save-config", payload);
    setOk("routingOk","Saved.");
    await loadConfig();
  }catch(e){
    setErr("routingErr", String(e.message||e));
  }
}

async function syncModels(){
  setErr("routingErr",""); setOk("routingOk","");
  try{
    await apiPost("/api/model-options/sync", {});
    setOk("routingOk","Synced model options (append-only).");
    await loadModelOptions();
  }catch(e){
    setErr("routingErr", String(e.message||e));
  }
}

async function savePrompt(){
  setErr("promptErr",""); setOk("promptOk","");
  try{
    await apiPost("/api/admin/save-config", { systemPrompt: document.getElementById("sysPrompt").value });
    setOk("promptOk","Saved.");
  }catch(e){
    setErr("promptErr", String(e.message||e));
  }
}

async function saveGuard(){
  setErr("guardErr",""); setOk("guardOk","");
  try{
    const maxCost = Number(document.getElementById("maxCost").value || 0);
    const maxTokens = Number(document.getElementById("maxTokens").value || 0);
    await apiPost("/api/admin/save-config", { guardrails: { maxCostPerRequestUSD: maxCost, maxTokensPerRequest: maxTokens } });
    setOk("guardOk","Saved.");
  }catch(e){
    setErr("guardErr", String(e.message||e));
  }
}

async function loadAll(){
  const ok = await refreshAuth();
  if(!ok) return;
  await Promise.all([loadStats(), loadConfig()]);
  await Promise.all([loadKeys(), loadModelOptions()]);
}

document.getElementById("loginBtn").onclick = login;
document.getElementById("setPwBtn").onclick = setPassword;
document.getElementById("logoutBtn").onclick = logout;
document.getElementById("resetStatsBtn").onclick = async ()=>{ await apiPost("/api/stats/reset",{}); await loadStats(); };
document.getElementById("saveRoutingBtn").onclick = saveRouting;
document.getElementById("syncModelsBtn").onclick = syncModels;
document.getElementById("savePromptBtn").onclick = savePrompt;
document.getElementById("saveGuardBtn").onclick = saveGuard;

loadAll();
</script>
</body>
</html>
