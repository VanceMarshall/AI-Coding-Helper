<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Admin - AI Code Helper</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0d1117;--bg2:#161b22;--bg3:#21262d;--bg4:#30363d;--border:#30363d;--text:#e6edf3;--text2:#8b949e;--text3:#6e7681;--accent:#58a6ff;--green:#3fb950;--red:#f85149;--yellow:#d29922;--purple:#a371f7;--sans:'Plus Jakarta Sans',sans-serif;--mono:'JetBrains Mono',monospace}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:var(--sans);background:var(--bg);color:var(--text);line-height:1.6;padding:16px;max-width:1200px;margin:0 auto}
    h1{font-size:24px;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:12px}
    h1 span{background:linear-gradient(135deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .subtitle{color:var(--text2);margin-bottom:24px;font-size:14px}
    .back-link{color:var(--accent);text-decoration:none;display:inline-flex;align-items:center;gap:6px;margin-bottom:20px;font-size:14px;padding:8px 0}
    .back-link:hover{text-decoration:underline}
    .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-bottom:24px}
    @media(min-width:768px){.grid{grid-template-columns:repeat(2,1fr)}}
    .card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:20px}
    .card h2{font-size:15px;font-weight:600;margin-bottom:14px;display:flex;align-items:center;gap:8px}
    .stat-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .stat{background:var(--bg3);padding:14px;border-radius:8px}
    .stat-label{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
    .stat-value{font-size:20px;font-weight:700;font-family:var(--mono)}
    .stat-value.cost{color:var(--green)}
    .provider-status{display:flex;gap:10px;flex-wrap:wrap}
    .provider-badge{display:flex;align-items:center;gap:6px;padding:8px 14px;background:var(--bg3);border-radius:20px;font-size:13px;font-weight:500}
    .provider-badge .dot{width:8px;height:8px;border-radius:50%}
    .provider-badge.active .dot{background:var(--green)}
    .provider-badge.inactive .dot{background:var(--red)}
    .model-card{background:var(--bg3);border-radius:8px;padding:14px;cursor:pointer;border:1px solid transparent;margin-bottom:10px}
    .model-card:hover{border-color:var(--accent)}
    .model-card:last-child{margin-bottom:0}
    .model-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:8px}
    .model-name{font-weight:600;font-size:14px}
    .model-badge{font-size:10px;padding:4px 10px;border-radius:12px;text-transform:uppercase;letter-spacing:.5px}
    .model-badge.fast{background:rgba(63,185,80,.15);color:var(--green)}
    .model-badge.full{background:rgba(88,166,255,.15);color:var(--accent)}
    .model-badge.fallback{background:rgba(163,113,247,.15);color:var(--purple)}
    .model-details{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;font-size:12px}
    .model-detail{display:flex;justify-content:space-between}
    .model-detail .label{color:var(--text2)}
    .model-detail .value{font-family:var(--mono)}
    .section-title{font-size:18px;font-weight:600;margin:24px 0 14px;padding-top:20px;border-top:1px solid var(--border)}
    .chart-bar-container{display:flex;align-items:flex-end;gap:4px;height:80px;padding:8px 0}
    .chart-bar{flex:1;background:var(--accent);border-radius:4px 4px 0 0;min-height:4px}
    .chart-labels{display:flex;justify-content:space-between;font-size:11px;color:var(--text3)}
    .breakdown-row{display:flex;align-items:center;padding:12px 0;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:8px}
    .breakdown-row:last-child{border-bottom:none}
    .breakdown-name{flex:1;font-weight:500;min-width:120px}
    .breakdown-stats{display:flex;gap:16px;font-size:12px;font-family:var(--mono)}
    .breakdown-stat{text-align:right}
    .breakdown-stat .label{font-size:10px;color:var(--text3);text-transform:uppercase}
    .form-group{margin-bottom:14px}
    .form-group label{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
    .form-group input,.form-group select{width:100%;padding:10px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px}
    .form-group input:focus,.form-group select:focus{outline:none;border-color:var(--accent)}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    button{padding:10px 20px;background:var(--accent);color:var(--bg);border:none;border-radius:8px;font-family:var(--sans);font-size:14px;font-weight:600;cursor:pointer;width:100%}
    @media(min-width:480px){button{width:auto}}
    button:hover{opacity:.9}
    button.secondary{background:var(--bg3);color:var(--text);border:1px solid var(--border)}
    button.danger{background:var(--red)}
    .button-row{display:flex;flex-direction:column;gap:10px;margin-top:14px}
    @media(min-width:480px){.button-row{flex-direction:row}}
    .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000;padding:16px}
    .modal.active{display:flex}
    .modal-content{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:20px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto}
    .modal h3{margin-bottom:16px;font-size:17px}
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:12px 20px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;display:none;max-width:90%}
    .toast.success{border-left:3px solid var(--green)}
    .toast.error{border-left:3px solid var(--red)}
    .project-row{display:flex;align-items:center;padding:12px;background:var(--bg3);border-radius:8px;margin-bottom:8px;flex-wrap:wrap;gap:8px}
    .project-row .name{flex:1;font-weight:500;min-width:150px}
    .project-row .cost{font-family:var(--mono);color:var(--green)}
  </style>
</head>
<body>
  <a href="/" class="back-link">‚Üê Back to Chat</a>
  <h1>‚öôÔ∏è <span>Admin Panel</span></h1>
  <p class="subtitle">Configure AI models, view usage stats, and manage settings</p>

  <div class="grid">
    <div class="card">
      <h2>üîå Provider Status</h2>
      <div class="provider-status" id="providerStatus"><div class="provider-badge inactive"><span class="dot"></span>Loading...</div></div>
    </div>
    <div class="card">
      <h2>üìä Usage Overview</h2>
      <div class="stat-grid">
        <div class="stat"><div class="stat-label">Total Cost</div><div class="stat-value cost" id="totalCost">$0.00</div></div>
        <div class="stat"><div class="stat-label">Requests</div><div class="stat-value" id="totalRequests">0</div></div>
        <div class="stat"><div class="stat-label">Input Tokens</div><div class="stat-value" id="totalInputTokens">0</div></div>
        <div class="stat"><div class="stat-label">Output Tokens</div><div class="stat-value" id="totalOutputTokens">0</div></div>
      </div>
      <div class="button-row"><button class="secondary danger" onclick="resetStats()">Reset Stats</button></div>
    </div>
  </div>

  <h3 class="section-title">ü§ñ Model Configuration</h3>
  <p class="subtitle">Tap on a model to edit its settings</p>
  <div class="grid" id="modelCards"></div>

  <h3 class="section-title">üìà Daily Usage (Last 7 Days)</h3>
  <div class="card">
    <div class="chart-bar-container" id="dailyChart"></div>
    <div class="chart-labels" id="chartLabels"></div>
  </div>

  <h3 class="section-title">üìã Usage by Model</h3>
  <div class="card"><div id="modelBreakdown"><p style="color:var(--text3)">No usage data yet</p></div></div>

  <h3 class="section-title">üìÅ Cost by Project</h3>
  <div class="card"><div id="projectBreakdown"><p style="color:var(--text3)">No project data yet</p></div></div>

  <div class="modal" id="editModal">
    <div class="modal-content">
      <h3 id="editModalTitle">Edit Model</h3>
      <form id="editModelForm">
        <input type="hidden" id="editModelKey">
        <div class="form-group"><label>Display Name</label><input type="text" id="editDisplayName" required></div>
        <div class="form-group"><label>Provider</label><select id="editProvider"><option value="openai">OpenAI</option><option value="anthropic">Anthropic</option><option value="google">Google</option></select></div>
        <div class="form-group"><label>Model ID</label><input type="text" id="editModelId" required></div>
        <div class="form-group"><label>Description</label><input type="text" id="editDescription"></div>
        <div class="form-row">
          <div class="form-group"><label>Input Cost ($/M)</label><input type="number" id="editInputCost" step="0.01" required></div>
          <div class="form-group"><label>Output Cost ($/M)</label><input type="number" id="editOutputCost" step="0.01" required></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Max Output Tokens</label><input type="number" id="editMaxTokens" required></div>
          <div class="form-group"><label>Context Window</label><input type="number" id="editContextWindow" required></div>
        </div>
        <div class="button-row"><button type="submit">Save</button><button type="button" class="secondary" onclick="closeEditModal()">Cancel</button></div>
      </form>
    </div>
  </div>
  <div class="toast" id="toast"></div>

<script>
let config=null,stats=null,projects=[];
function showToast(m,t='success'){const e=document.getElementById('toast');e.textContent=m;e.className=`toast ${t}`;e.style.display='block';setTimeout(()=>e.style.display='none',3000)}
function fmt(n){if(n>=1e6)return(n/1e6).toFixed(2)+'M';if(n>=1e3)return(n/1e3).toFixed(1)+'K';return n.toString()}

async function loadConfig(){config=await(await fetch('/api/config')).json();renderProviderStatus();renderModelCards()}
async function loadStats(){stats=await(await fetch('/api/stats')).json();renderStats();renderDailyChart();renderModelBreakdown();renderProjectBreakdown()}
async function loadProjects(){projects=await(await fetch('/api/projects/local')).json()}

function renderProviderStatus(){
  document.getElementById('providerStatus').innerHTML=[['openai','OpenAI'],['anthropic','Anthropic'],['google','Google']].map(([k,n])=>`<div class="provider-badge ${config.providers[k]?'active':'inactive'}"><span class="dot"></span>${n}</div>`).join('');
}

function renderModelCards(){
  document.getElementById('modelCards').innerHTML=Object.entries(config.models).map(([k,m])=>`<div class="card" style="cursor:pointer" onclick="openEditModal('${k}')"><div class="model-card"><div class="model-header"><span class="model-name">${m.displayName}</span><span class="model-badge ${k}">${k}</span></div><div class="model-details"><div class="model-detail"><span class="label">Provider</span><span class="value">${m.provider}</span></div><div class="model-detail"><span class="label">Model</span><span class="value">${m.model}</span></div><div class="model-detail"><span class="label">Input</span><span class="value">$${m.inputCost}/M</span></div><div class="model-detail"><span class="label">Output</span><span class="value">$${m.outputCost}/M</span></div></div></div></div>`).join('');
}

function renderStats(){
  document.getElementById('totalCost').textContent='$'+(stats.totalCost||0).toFixed(4);
  document.getElementById('totalRequests').textContent=fmt(stats.requestCount||0);
  document.getElementById('totalInputTokens').textContent=fmt(stats.totalInputTokens||0);
  document.getElementById('totalOutputTokens').textContent=fmt(stats.totalOutputTokens||0);
}

function renderDailyChart(){
  const days=[];for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);days.push(d.toISOString().split('T')[0])}
  const costs=days.map(d=>stats.dailyStats?.[d]?.cost||0);
  const max=Math.max(...costs,0.01);
  document.getElementById('dailyChart').innerHTML=days.map((d,i)=>`<div class="chart-bar" style="height:${Math.max((costs[i]/max)*100,4)}%" title="${d}: $${costs[i].toFixed(4)}"></div>`).join('');
  document.getElementById('chartLabels').innerHTML=`<span>${days[0].slice(5)}</span><span>${days[6].slice(5)}</span>`;
}

function renderModelBreakdown(){
  const c=document.getElementById('modelBreakdown');
  if(!stats.byModel||!Object.keys(stats.byModel).length){c.innerHTML='<p style="color:var(--text3)">No usage data yet</p>';return}
  c.innerHTML=Object.entries(stats.byModel).map(([k,d])=>`<div class="breakdown-row"><div class="breakdown-name">${k}</div><div class="breakdown-stats"><div class="breakdown-stat"><div class="label">Reqs</div><div>${d.requests}</div></div><div class="breakdown-stat"><div class="label">Tokens</div><div>${fmt(d.inputTokens+d.outputTokens)}</div></div><div class="breakdown-stat"><div class="label">Cost</div><div>$${d.cost.toFixed(4)}</div></div></div></div>`).join('');
}

function renderProjectBreakdown(){
  const c=document.getElementById('projectBreakdown');
  if(!stats.byProject||!Object.keys(stats.byProject).length){c.innerHTML='<p style="color:var(--text3)">No project data yet</p>';return}
  c.innerHTML=Object.entries(stats.byProject).map(([k,d])=>`<div class="project-row"><div class="name">${k}</div><div class="cost">$${d.cost.toFixed(4)}</div></div>`).join('');
}

function openEditModal(k){
  const m=config.models[k];if(!m)return;
  document.getElementById('editModelKey').value=k;
  document.getElementById('editModalTitle').textContent=`Edit ${m.displayName}`;
  document.getElementById('editDisplayName').value=m.displayName;
  document.getElementById('editProvider').value=m.provider;
  document.getElementById('editModelId').value=m.model;
  document.getElementById('editDescription').value=m.description||'';
  document.getElementById('editInputCost').value=m.inputCost;
  document.getElementById('editOutputCost').value=m.outputCost;
  document.getElementById('editMaxTokens').value=m.maxOutputTokens;
  document.getElementById('editContextWindow').value=m.contextWindow;
  document.getElementById('editModal').classList.add('active');
}
function closeEditModal(){document.getElementById('editModal').classList.remove('active')}

document.getElementById('editModelForm').addEventListener('submit',async e=>{
  e.preventDefault();
  const k=document.getElementById('editModelKey').value;
  const u={displayName:document.getElementById('editDisplayName').value,provider:document.getElementById('editProvider').value,model:document.getElementById('editModelId').value,description:document.getElementById('editDescription').value,inputCost:parseFloat(document.getElementById('editInputCost').value),outputCost:parseFloat(document.getElementById('editOutputCost').value),maxOutputTokens:parseInt(document.getElementById('editMaxTokens').value),contextWindow:parseInt(document.getElementById('editContextWindow').value)};
  try{const r=await(await fetch('/api/config/models',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({modelKey:k,updates:u})})).json();if(r.error)throw new Error(r.error);config.models[k]=r.model;renderModelCards();closeEditModal();showToast('Model updated!')}catch(e){showToast('Failed: '+e.message,'error')}
});

async function resetStats(){if(!confirm('Reset all stats?'))return;try{await fetch('/api/stats/reset',{method:'POST'});await loadStats();showToast('Stats reset!')}catch(e){showToast('Failed','error')}}

document.getElementById('editModal').addEventListener('click',e=>{if(e.target===document.getElementById('editModal'))closeEditModal()});

loadConfig();loadStats();loadProjects();
</script>
</body>
</html>
