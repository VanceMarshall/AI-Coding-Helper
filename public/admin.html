<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>AI Coding Helper Admin</title>
  <style>
    :root{--bg:#0d1117;--bg2:#161b22;--bg3:#21262d;--text:#e6edf3;--muted:#8b949e;--accent:#58a6ff;--green:#2ea043;--red:#f85149;--yellow:#d29922;--radius:14px}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#090b10);color:var(--text)}
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:38px;height:38px;border-radius:10px;background:radial-gradient(circle at 30% 30%,#7ee787,transparent 55%),radial-gradient(circle at 70% 70%,#58a6ff,transparent 55%),var(--bg3);border:1px solid #30363d}
    h1{font-size:18px;margin:0}
    .pill{font-size:12px;padding:6px 10px;border:1px solid #30363d;border-radius:999px;color:var(--muted);background:rgba(33,38,45,.4)}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:rgba(22,27,34,.65);border:1px solid #30363d;border-radius:var(--radius);padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);backdrop-filter:blur(10px)}
    .card h2{margin:0 0 10px;font-size:14px;color:#c9d1d9}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > *{flex:1}
    .row .auto{flex:0}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px}
    input,select,textarea{width:100%;background:rgba(13,17,23,.6);border:1px solid #30363d;border-radius:12px;color:var(--text);padding:10px 12px;outline:none}
    textarea{min-height:90px;resize:vertical}
    button{cursor:pointer;border:none;border-radius:12px;padding:10px 12px;background:var(--accent);color:#081018;font-weight:700}
    button.secondary{background:rgba(88,166,255,.15);color:var(--text);border:1px solid #30363d}
    button.danger{background:rgba(248,81,73,.14);color:var(--text);border:1px solid rgba(248,81,73,.35)}
    button:disabled{opacity:.5;cursor:not-allowed}
    .muted{color:var(--muted);font-size:12px}
    .status{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted)}
    .dot{width:9px;height:9px;border-radius:999px;background:var(--muted)}
    .dot.ok{background:var(--green)}
    .dot.warn{background:var(--yellow)}
    .dot.bad{background:var(--red)}
    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:rgba(33,38,45,.95);border:1px solid #30363d;border-radius:14px;padding:10px 14px;display:none;max-width:560px}
    .toast.show{display:block}
    .toast b{margin-right:8px}
    .hidden{display:none!important}
    .divider{height:1px;background:#30363d;margin:12px 0}
    .kpi{display:flex;gap:14px;flex-wrap:wrap}
    .kpi .item{flex:1;min-width:140px;background:rgba(13,17,23,.55);border:1px solid #30363d;border-radius:12px;padding:10px}
    .kpi .item .v{font-size:18px;font-weight:800}
    .badge{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid #30363d;background:rgba(13,17,23,.55);color:var(--muted)}
    .right{display:flex;align-items:center;gap:10px}
    .mini{font-size:12px;padding:8px 10px;border-radius:12px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>AI Coding Helper Admin</h1>
        <div class="muted">Manage providers, models, keys, and sync</div>
      </div>
    </div>
    <div class="right">
      <span id="modelSyncStatus" class="pill">Model list: not synced yet</span>
      <button id="logoutBtn" class="secondary mini hidden" onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- Login / Setup -->
  <div id="loginScreen" class="card hidden">
    <h2 id="loginTitle">Admin Login</h2>
    <div class="muted" id="loginHint">Enter your admin password.</div>
    <form id="loginForm" onsubmit="login(event)">
      <label>Password</label>
      <input id="loginPassword" type="password" autocomplete="current-password" required />
      <div id="confirmWrap" class="hidden">
        <label>Confirm password</label>
        <input id="confirmPassword" type="password" autocomplete="new-password" />
      </div>
      <div class="row" style="margin-top:12px">
        <button id="loginBtn" type="submit">Login</button>
      </div>
    </form>
  </div>

  <!-- Main Admin -->
  <div id="adminPanel" class="grid hidden">

    <div class="card">
      <h2>Quick Stats</h2>
      <div class="kpi">
        <div class="item">
          <div class="muted">Total Messages</div>
          <div class="v" id="totalMessages">-</div>
        </div>
        <div class="item">
          <div class="muted">Total Cost</div>
          <div class="v" id="totalCost">-</div>
        </div>
        <div class="item">
          <div class="muted">Providers</div>
          <div class="v" id="providerCount">-</div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="row">
        <button class="danger" onclick="resetStats()">Reset Stats</button>
        <span class="muted">Clears saved usage cost totals.</span>
      </div>
    </div>

    <div class="card">
      <h2>API Keys</h2>
      <div class="muted">These reflect Railway env vars if set, otherwise stored values.</div>
      <div class="divider"></div>
      <div id="keyList"></div>
    </div>

    <div class="card">
      <h2>Model Routing</h2>
      <div class="muted">Dropdowns let you choose models for fast/full/fallback. No automatic changes unless you save.</div>

      <label>Fast Model</label>
      <select id="fastModel"></select>

      <label>Full Model</label>
      <select id="fullModel"></select>

      <label>Fallback Model</label>
      <select id="fallbackModel"></select>

      <div class="row" style="margin-top:12px">
        <button onclick="saveConfig()">Save</button>
        <button class="secondary" onclick="syncModels()">Sync Model Options</button>
      </div>
      <div class="muted" style="margin-top:8px">Sync adds options to the list, it does not change your selected models.</div>
    </div>

    <div class="card">
      <h2>System Prompt</h2>
      <div class="muted">Edits apply to the assistant across providers.</div>
      <label>Prompt</label>
      <textarea id="systemPrompt"></textarea>
      <div class="row" style="margin-top:12px">
        <button onclick="saveConfig()">Save</button>
      </div>
    </div>

    <div class="card">
      <h2>Cost Guardrails</h2>
      <div class="muted">Optional caps to prevent runaway spend.</div>

      <label>Max Cost Per Request (USD)</label>
      <input id="maxCostPerRequest" type="number" step="0.01" min="0" />

      <label>Max Tokens Per Request</label>
      <input id="maxTokensPerRequest" type="number" step="1" min="0" />

      <div class="row" style="margin-top:12px">
        <button onclick="saveConfig()">Save</button>
      </div>
    </div>

  </div>
</div>

<div id="toast" class="toast"></div>

<script>
const SESSION_KEY='adminSession';
let config=null,stats=null,apiKeys={},modelOptions={},sessionToken=localStorage.getItem(SESSION_KEY);

const providerNames={openai:'OpenAI',anthropic:'Anthropic',google:'Google',github:'GitHub'};
function showToast(msg,type='ok'){
  const t=document.getElementById('toast');
  const color=type==='error'?'bad':(type==='warn'?'warn':'ok');
  t.innerHTML=`<b class="badge">${type.toUpperCase()}</b> ${msg}`;
  t.className='toast show';
  setTimeout(()=>t.className='toast',3400);
}
function fmtMoney(n){try{return '$'+Number(n).toFixed(4)}catch{return '$0.0000'}}
function fmtInt(n){if(n==null)return '-';n=Number(n);if(n>1e6)return (n/1e6).toFixed(2)+'M';if(n>1e3)return (n/1e3).toFixed(1)+'K';return n.toString()}

function authHeaders(){
  if(!sessionToken) return {};
  // Send both cases for maximum compatibility with any server/header parsing
  return {'x-admin-session': sessionToken, 'X-Admin-Session': sessionToken};
}

async function checkAuth(){
  try{
    const r=await fetch('/api/admin/auth-status',{headers:authHeaders()});
    const d=await r.json();

    // Support multiple backend response shapes
    const needsPassword = (d.needsPassword !== undefined)
      ? d.needsPassword
      : (d.hasPassword !== undefined ? !d.hasPassword : false);

    const isAuthenticated = (d.isAuthenticated !== undefined)
      ? d.isAuthenticated
      : (d.authenticated !== undefined ? d.authenticated : false);

    if(needsPassword){
      showSetupScreen();
    }else if(!isAuthenticated){
      showLoginScreen();
    }else{
      showAdminPanel();
    }
  }catch(e){
    showToast('Auth check failed: '+e.message,'error');
    showLoginScreen();
  }
}

function showSetupScreen(){
  document.getElementById('loginTitle').textContent='Set Admin Password';
  document.getElementById('loginHint').textContent='Create a new admin password to secure settings.';
  document.getElementById('confirmWrap').classList.remove('hidden');
  document.getElementById('loginForm').onsubmit=setupPassword;
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('adminPanel').classList.add('hidden');
  document.getElementById('logoutBtn').classList.add('hidden');
}
function showLoginScreen(){
  document.getElementById('loginTitle').textContent='Admin Login';
  document.getElementById('loginHint').textContent='Enter your admin password.';
  document.getElementById('confirmWrap').classList.add('hidden');
  document.getElementById('loginForm').onsubmit=login;
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('adminPanel').classList.add('hidden');
  document.getElementById('logoutBtn').classList.add('hidden');
}
function showAdminPanel(){
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('adminPanel').classList.remove('hidden');
  document.getElementById('logoutBtn').classList.remove('hidden');
  loadAll();
}

async function setupPassword(e){
  e.preventDefault();
  const pw=document.getElementById('loginPassword').value;
  const confirm=document.getElementById('confirmPassword').value;
  if(pw!==confirm){showToast('Passwords do not match','error');return}

  try{
    const r=await fetch('/api/admin/setup-password',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({password:pw})
    });
    const d=await r.json();
    if(d.error)throw new Error(d.error);

    sessionToken=(d.sessionToken||d.token);
    if(!sessionToken) throw new Error('Password set but no session token returned');

    localStorage.setItem(SESSION_KEY,sessionToken);
    showAdminPanel();
    showToast('Password created!');
  }catch(e){showToast(e.message,'error')}
}

async function login(e){
  e.preventDefault();
  const pw=document.getElementById('loginPassword').value;

  try{
    const r=await fetch('/api/admin/login',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({password:pw})
    });
    const d=await r.json();
    if(d.error)throw new Error(d.error);

    sessionToken=(d.sessionToken||d.token);
    if(!sessionToken) throw new Error('Login succeeded but no session token returned');

    localStorage.setItem(SESSION_KEY,sessionToken);
    showAdminPanel();
    showToast('Logged in!');
  }catch(e){showToast(e.message,'error')}
}

async function logout(){
  await fetch('/api/admin/logout',{method:'POST',headers:authHeaders()});
  sessionToken=null;
  localStorage.removeItem(SESSION_KEY);
  showLoginScreen();
}

async function loadAll(){
  await Promise.all([loadConfig(),loadStats(),loadApiKeys(),loadModelOptions()]);
  populateConfigUI();
  renderKeys();
  renderModelDropdowns();
  updateModelSyncStatus();
}

async function loadConfig(){
  const r=await fetch('/api/config',{headers:authHeaders()});
  if(!r.ok) throw new Error('Failed to load config');
  config=await r.json();
}

async function loadStats(){
  const r=await fetch('/api/stats',{headers:authHeaders()});
  if(!r.ok) throw new Error('Failed to load stats');
  stats=await r.json();
  document.getElementById('totalMessages').textContent=fmtInt(stats.totalMessages||0);
  document.getElementById('totalCost').textContent=fmtMoney(stats.totalCost||0);
  document.getElementById('providerCount').textContent=Object.keys(stats.byProvider||{}).length;
}

async function loadApiKeys(){
  const r=await fetch('/api/admin/api-keys',{headers:authHeaders()});
  if(r.status===401) throw new Error('Unauthorized');
  apiKeys=await r.json();
}

async function loadModelOptions(){
  const r=await fetch('/api/model-options',{headers:authHeaders()});
  if(r.status===401) throw new Error('Unauthorized');
  modelOptions=await r.json();
}

function populateConfigUI(){
  if(!config) return;
  document.getElementById('systemPrompt').value=config.systemPrompt||'';
  document.getElementById('maxCostPerRequest').value=(config.guardrails && config.guardrails.maxCostPerRequest!=null) ? config.guardrails.maxCostPerRequest : '';
  document.getElementById('maxTokensPerRequest').value=(config.guardrails && config.guardrails.maxTokensPerRequest!=null) ? config.guardrails.maxTokensPerRequest : '';
}

function renderKeys(){
  const wrap=document.getElementById('keyList');
  wrap.innerHTML='';
  const providers=['openai','anthropic','google','github'];
  providers.forEach(p=>{
    const meta=apiKeys[p]||{};
    const row=document.createElement('div');
    row.className='row';
    row.innerHTML=`
      <div class="auto">
        <span class="badge">${providerNames[p]||p}</span>
      </div>
      <div>
        <div class="muted">${meta.masked||'(not set)'}</div>
      </div>
    `;
    wrap.appendChild(row);
  });
}

function allModelOptions(){
  // Expecting response: { modelOptions: { openai:[], anthropic:[], google:[] }, lastSyncAt }
  const mo=(modelOptions && (modelOptions.modelOptions||modelOptions)) || {};
  return {
    openai: mo.openai || [],
    anthropic: mo.anthropic || [],
    google: mo.google || []
  };
}

function renderModelDropdowns(){
  const mo=allModelOptions();
  const fast=document.getElementById('fastModel');
  const full=document.getElementById('fullModel');
  const fallback=document.getElementById('fallbackModel');

  function fill(sel, list){
    sel.innerHTML='';
    (list||[]).forEach(m=>{
      const opt=document.createElement('option');
      opt.value=typeof m==='string'?m:m.id||m.model||'';
      opt.textContent=typeof m==='string'?m:(m.label||m.id||m.model||'');
      sel.appendChild(opt);
    });
  }

  // Flatten: we allow mixing providers in dropdowns by using "provider:model"
  const combined=[
    ...mo.openai.map(x=> (typeof x==='string'?`openai:${x}`:`openai:${x.id||x.model}`)),
    ...mo.anthropic.map(x=> (typeof x==='string'?`anthropic:${x}`:`anthropic:${x.id||x.model}`)),
    ...mo.google.map(x=> (typeof x==='string'?`google:${x}`:`google:${x.id||x.model}`))
  ].filter(Boolean);

  fill(fast, combined);
  fill(full, combined);
  fill(fallback, combined);

  // Set selected values from config
  if(config && config.models){
    if(config.models.fast && config.models.fast.provider && config.models.fast.model){
      fast.value=`${config.models.fast.provider}:${config.models.fast.model}`;
    }
    if(config.models.full && config.models.full.provider && config.models.full.model){
      full.value=`${config.models.full.provider}:${config.models.full.model}`;
    }
    if(config.models.fallback && config.models.fallback.provider && config.models.fallback.model){
      fallback.value=`${config.models.fallback.provider}:${config.models.fallback.model}`;
    }
  }
}

function latestSync(){
  // Support either {lastSyncAt} or provider-level timestamps
  if(modelOptions && modelOptions.lastSyncAt) return modelOptions.lastSyncAt;
  return null;
}

function updateModelSyncStatus(){
  const d=latestSync();
  document.getElementById('modelSyncStatus').textContent = d ? `Model list synced: ${new Date(d).toLocaleString()}` : 'Model list: not synced yet';
}

function parseProviderModel(v){
  const [provider,...rest]=String(v||'').split(':');
  return {provider, model: rest.join(':')};
}

async function saveConfig(){
  try{
    const fast=parseProviderModel(document.getElementById('fastModel').value);
    const full=parseProviderModel(document.getElementById('fullModel').value);
    const fallback=parseProviderModel(document.getElementById('fallbackModel').value);

    config=config||{};
    config.systemPrompt=document.getElementById('systemPrompt').value||'';
    config.models=config.models||{};
    config.models.fast={provider: fast.provider, model: fast.model};
    config.models.full={provider: full.provider, model: full.model};
    config.models.fallback={provider: fallback.provider, model: fallback.model};

    config.guardrails=config.guardrails||{};
    const mc=document.getElementById('maxCostPerRequest').value;
    const mt=document.getElementById('maxTokensPerRequest').value;
    config.guardrails.maxCostPerRequest = mc==='' ? null : Number(mc);
    config.guardrails.maxTokensPerRequest = mt==='' ? null : Number(mt);

    const r=await fetch('/api/config',{
      method:'POST',
      headers:{'Content-Type':'application/json',...authHeaders()},
      body:JSON.stringify(config)
    });
    const d=await r.json();
    if(!r.ok) throw new Error(d.error||'Save failed');
    showToast('Saved config!');
  }catch(e){showToast(e.message,'error')}
}

async function syncModels(){
  try{
    const r=await fetch('/api/model-options/sync',{method:'POST',headers:authHeaders()});
    const d=await r.json();
    if(!r.ok) throw new Error(d.error||'Sync failed');
    await loadModelOptions();
    renderModelDropdowns();
    updateModelSyncStatus();
    showToast('Model options synced!');
  }catch(e){showToast(e.message,'error')}
}

async function resetStats(){
  try{
    const r=await fetch('/api/stats/reset',{method:'POST',headers:authHeaders()});
    const d=await r.json();
    if(!r.ok) throw new Error(d.error||'Reset failed');
    await loadStats();
    showToast('Stats reset!');
  }catch(e){showToast(e.message,'error')}
}

checkAuth();
</script>
</body>
</html>
