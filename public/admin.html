<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel</title>
  <link rel="stylesheet" href="/admin.css" />
</head>
<body>

<div id="loginView">
  <h2>Admin Login</h2>
  <input id="adminPassword" type="password" placeholder="Password" />
  <button onclick="login()">Login</button>
  <p id="loginError" class="error"></p>
</div>

<div id="adminView" style="display:none;">
  <!-- existing admin UI markup unchanged -->
</div>

<script>
/* ===========================
   SESSION + AUTH HELPERS
=========================== */

const SESSION_KEY = "adminSession";
let sessionToken = localStorage.getItem(SESSION_KEY) || "";

function setSession(token) {
  sessionToken = token;
  localStorage.setItem(SESSION_KEY, token);
}

function clearSession() {
  sessionToken = "";
  localStorage.removeItem(SESSION_KEY);
}

function authHeaders() {
  return sessionToken ? { "x-admin-session": sessionToken } : {};
}

async function authedFetch(url, options = {}) {
  return fetch(url, {
    ...options,
    headers: {
      ...(options.headers || {}),
      ...authHeaders()
    }
  });
}

/* ===========================
   AUTH FLOW
=========================== */

async function login() {
  const pw = document.getElementById("adminPassword").value;
  document.getElementById("loginError").textContent = "";

  try {
    const r = await fetch("/api/admin/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ password: pw })
    });

    const d = await r.json();

    // BACKEND HARDENING COMPAT
    const token = d.sessionToken || d.token;

    if (!d.ok || !token) {
      throw new Error("Invalid login response");
    }

    setSession(token);
    await showAdminPanel();
  } catch (e) {
    clearSession();
    document.getElementById("loginError").textContent = "Login failed";
  }
}

async function showAdminPanel() {
  document.getElementById("loginView").style.display = "none";
  document.getElementById("adminView").style.display = "block";

  try {
    await loadAll();
  } catch (e) {
    clearSession();
    location.reload();
  }
}

/* ===========================
   ADMIN DATA LOADERS
=========================== */

async function loadAll() {
  await Promise.all([
    loadConfig(),
    loadStats(),
    loadApiKeys(),
    loadModelOptions()
  ]);
}

async function loadConfig() {
  const r = await fetch("/api/config");
  if (!r.ok) throw new Error("Config failed");
  // existing logic untouched
}

async function loadStats() {
  const r = await authedFetch("/api/stats");
  if (!r.ok) throw new Error("Stats failed");
  // existing logic untouched
}

async function loadApiKeys() {
  const r = await authedFetch("/api/admin/api-keys");
  if (!r.ok) throw new Error("API keys unauthorized");
  // existing logic untouched
}

async function loadModelOptions() {
  const r = await authedFetch("/api/model-options");
  if (!r.ok) throw new Error("Model options unauthorized");
  // existing logic untouched
}

/* ===========================
   INITIAL BOOTSTRAP
=========================== */

(async function bootstrap() {
  if (!sessionToken) return;

  try {
    const r = await authedFetch("/api/admin/auth-status");
    const d = await r.json();
    if (d.authenticated) {
      await showAdminPanel();
    } else {
      clearSession();
    }
  } catch {
    clearSession();
  }
})();
</script>

</body>
</html>
