<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Admin - AI Code Helper</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0d1117;--bg2:#161b22;--bg3:#21262d;--bg4:#30363d;--border:#30363d;--text:#e6edf3;--text2:#8b949e;--text3:#6e7681;--accent:#58a6ff;--green:#3fb950;--red:#f85149;--yellow:#d29922;--purple:#a371f7;--sans:'Plus Jakarta Sans',sans-serif;--mono:'JetBrains Mono',monospace}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:var(--sans);background:var(--bg);color:var(--text);line-height:1.6;padding:16px;max-width:1200px;margin:0 auto}
    h1{font-size:24px;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:12px}
    h1 span{background:linear-gradient(135deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .subtitle{color:var(--text2);margin-bottom:24px;font-size:14px}
    .back-link{color:var(--accent);text-decoration:none;display:inline-flex;align-items:center;gap:6px;margin-bottom:20px;font-size:14px;padding:8px 0}
    .back-link:hover{text-decoration:underline}
    .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-bottom:24px}
    @media(min-width:768px){.grid{grid-template-columns:repeat(2,1fr)}}
    .card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:20px}
    .card h2{font-size:15px;font-weight:600;margin-bottom:14px;display:flex;align-items:center;gap:8px}
    .stat-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .stat{background:var(--bg3);padding:14px;border-radius:8px}
    .stat-label{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
    .stat-value{font-size:20px;font-weight:700;font-family:var(--mono)}
    .stat-value.cost{color:var(--green)}
    .provider-status{display:flex;gap:10px;flex-wrap:wrap}
    .provider-badge{display:flex;align-items:center;gap:6px;padding:8px 14px;background:var(--bg3);border-radius:20px;font-size:13px;font-weight:500}
    .provider-badge .dot{width:8px;height:8px;border-radius:50%}
    .provider-badge.active .dot{background:var(--green)}
    .provider-badge.inactive .dot{background:var(--red)}
    .api-key-row{display:flex;align-items:center;padding:14px;background:var(--bg3);border-radius:8px;margin-bottom:10px;flex-wrap:wrap;gap:10px}
    .api-key-row:last-child{margin-bottom:0}
    .api-key-info{flex:1;min-width:150px}
    .api-key-name{font-weight:600;font-size:14px;margin-bottom:2px}
    .api-key-value{font-family:var(--mono);font-size:12px;color:var(--text2)}
    .api-key-source{font-size:10px;padding:2px 6px;border-radius:4px;margin-left:8px}
    .api-key-source.env{background:rgba(88,166,255,0.2);color:var(--accent)}
    .api-key-source.config{background:rgba(210,153,34,0.2);color:var(--yellow)}
    .api-key-status{display:flex;align-items:center;gap:6px;font-size:12px}
    .api-key-status .dot{width:8px;height:8px;border-radius:50%}
    .api-key-status.connected .dot{background:var(--green)}
    .api-key-status.disconnected .dot{background:var(--red)}
    .api-key-actions{display:flex;gap:6px}
    .api-key-actions button{padding:6px 12px;font-size:12px;border-radius:6px;cursor:pointer;border:1px solid var(--border);background:var(--bg4);color:var(--text);font-family:var(--sans)}
    .api-key-actions button:hover{border-color:var(--accent)}
    .api-key-actions button.danger:hover{border-color:var(--red);color:var(--red)}
    .env-notice{font-size:11px;color:var(--text3);margin-top:12px;padding:10px;background:var(--bg3);border-radius:6px;border-left:3px solid var(--accent)}
    .model-card{background:var(--bg3);border-radius:8px;padding:14px;cursor:pointer;border:1px solid transparent;margin-bottom:10px}
    .model-card:hover{border-color:var(--accent)}
    .model-card:last-child{margin-bottom:0}
    .model-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:8px}
    .model-name{font-weight:600;font-size:14px}
    .model-badge{font-size:10px;padding:4px 10px;border-radius:12px;text-transform:uppercase;letter-spacing:.5px}
    .model-badge.fast{background:rgba(63,185,80,.15);color:var(--green)}
    .model-badge.full{background:rgba(88,166,255,.15);color:var(--accent)}
    .model-badge.fallback{background:rgba(163,113,247,.15);color:var(--purple)}
    .model-details{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;font-size:12px}
    .model-detail{display:flex;justify-content:space-between}
    .model-detail .label{color:var(--text2)}
    .model-detail .value{font-family:var(--mono)}
    .section-title{font-size:18px;font-weight:600;margin:24px 0 14px;padding-top:20px;border-top:1px solid var(--border)}
    .chart-bar-container{display:flex;align-items:flex-end;gap:4px;height:80px;padding:8px 0}
    .chart-bar{flex:1;background:var(--accent);border-radius:4px 4px 0 0;min-height:4px}
    .chart-labels{display:flex;justify-content:space-between;font-size:11px;color:var(--text3)}
    .breakdown-row{display:flex;align-items:center;padding:12px 0;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:8px}
    .breakdown-row:last-child{border-bottom:none}
    .breakdown-name{flex:1;font-weight:500;min-width:120px}
    .breakdown-stats{display:flex;gap:16px;font-size:12px;font-family:var(--mono)}
    .breakdown-stat{text-align:right}
    .breakdown-stat .label{font-size:10px;color:var(--text3);text-transform:uppercase}
    .form-group{margin-bottom:14px}
    .form-group label{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
    .form-group input,.form-group select{width:100%;padding:10px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px}
    .form-group input:focus,.form-group select:focus{outline:none;border-color:var(--accent)}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    button{padding:10px 20px;background:var(--accent);color:var(--bg);border:none;border-radius:8px;font-family:var(--sans);font-size:14px;font-weight:600;cursor:pointer;width:100%}
    @media(min-width:480px){button{width:auto}}
    button:hover{opacity:.9}
    button.secondary{background:var(--bg3);color:var(--text);border:1px solid var(--border)}
    button.danger{background:var(--red)}
    .button-row{display:flex;flex-direction:column;gap:10px;margin-top:14px}
    @media(min-width:480px){.button-row{flex-direction:row}}
    .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000;padding:16px}
    .modal.active{display:flex}
    .modal-content{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:20px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto}
    .modal h3{margin-bottom:16px;font-size:17px}
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:12px 20px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;display:none;max-width:90%;z-index:2000}
    .toast.success{border-left:3px solid var(--green)}
    .toast.error{border-left:3px solid var(--red)}
    .login-container{display:flex;align-items:center;justify-content:center;min-height:80vh}
    .login-box{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:32px;width:100%;max-width:400px;text-align:center}
    .login-box h2{margin-bottom:8px}
    .login-box p{color:var(--text2);margin-bottom:24px;font-size:14px}
    .login-box .form-group{text-align:left}
    .login-box button{width:100%;margin-top:8px}
    .hidden{display:none!important}
    .logout-btn{position:fixed;top:16px;right:16px;padding:8px 16px;font-size:12px}
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen" class="login-container hidden">
    <div class="login-box">
      <h2>üîí Admin Access</h2>
      <p id="loginMessage">Enter your admin password</p>
      <form id="loginForm">
        <div class="form-group">
          <label id="passwordLabel">Password</label>
          <input type="password" id="loginPassword" required minlength="6">
        </div>
        <div class="form-group hidden" id="confirmPasswordGroup">
          <label>Confirm Password</label>
          <input type="password" id="confirmPassword" minlength="6">
        </div>
        <button type="submit" id="loginBtn">Login</button>
      </form>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="hidden">
    <button class="secondary logout-btn" onclick="logout()">Logout</button>
    <a href="/" class="back-link">‚Üê Back to Chat</a>
    <h1>‚öôÔ∏è <span>Admin Panel</span></h1>
    <p class="subtitle">Configure API keys, AI models, and view usage stats</p>

    <h3 class="section-title" style="margin-top:0;padding-top:0;border:none">üîë API Keys</h3>
    <div class="card">
      <div id="apiKeysList"></div>
      <div class="env-notice">
        ‚ö†Ô∏è Environment variables (set in Railway/hosting) take priority over keys entered here.
      </div>
    </div>

    <div class="grid" style="margin-top:24px">
      <div class="card">
        <h2>üîå Provider Status</h2>
        <div class="provider-status" id="providerStatus"><div class="provider-badge inactive"><span class="dot"></span>Loading...</div></div>
      </div>
      <div class="card">
        <h2>üìä Usage Overview</h2>
        <div class="stat-grid">
          <div class="stat"><div class="stat-label">Total Cost</div><div class="stat-value cost" id="totalCost">$0.00</div></div>
          <div class="stat"><div class="stat-label">Requests</div><div class="stat-value" id="totalRequests">0</div></div>
          <div class="stat"><div class="stat-label">Input Tokens</div><div class="stat-value" id="totalInputTokens">0</div></div>
          <div class="stat"><div class="stat-label">Output Tokens</div><div class="stat-value" id="totalOutputTokens">0</div></div>
        </div>
        <div class="button-row"><button class="secondary danger" onclick="resetStats()">Reset Stats</button></div>
      </div>
    </div>

    <h3 class="section-title">ü§ñ Model Configuration</h3>
    <p class="subtitle">Tap on a model to edit its settings</p>
    <div class="button-row" style="margin:10px 0 14px 0;justify-content:space-between">
      <div style="color:var(--text3);font-size:13px" id="modelSyncStatus">Model list: not loaded</div>
      <button class="secondary" onclick="syncModelOptions()" type="button">Sync model options</button>
    </div>
    <div class="grid" id="modelCards"></div>

    <h3 class="section-title">üìà Daily Usage (Last 7 Days)</h3>
    <div class="card">
      <div class="chart-bar-container" id="dailyChart"></div>
      <div class="chart-labels" id="chartLabels"></div>
    </div>

    <h3 class="section-title">üìã Usage by Model</h3>
    <div class="card"><div id="modelBreakdown"><p style="color:var(--text3)">No usage data yet</p></div></div>

    <h3 class="section-title">üîê Security</h3>
    <div class="card">
      <h2>Change Admin Password</h2>
      <form id="changePasswordForm">
        <div class="form-group">
          <label>Current Password</label>
          <input type="password" id="currentPassword" required>
        </div>
        <div class="form-group">
          <label>New Password</label>
          <input type="password" id="newPassword" required minlength="6">
        </div>
        <button type="submit">Update Password</button>
      </form>
    </div>
  </div>

  <!-- Edit Model Modal -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <h3 id="editModalTitle">Edit Model</h3>
      <form id="editModelForm">
        <input type="hidden" id="editModelKey">
        <div class="form-group"><label>Display Name</label><input type="text" id="editDisplayName" required></div>
        <div class="form-group"><label>Provider</label><select id="editProvider"><option value="openai">OpenAI</option><option value="anthropic">Anthropic</option><option value="google">Google</option></select></div>
        <div class="form-group">
          <label>Model ID</label>
          <select id="editModelIdSelect"></select>
          <input type="text" id="editModelId" required style="margin-top:8px" placeholder="Custom model id">
          <div style="color:var(--text3);font-size:12px;margin-top:6px">Tip: Pick from the synced list above, or type a custom model id.</div>
        </div>
        <div class="form-group"><label>Description</label><input type="text" id="editDescription"></div>
        <div class="form-row">
          <div class="form-group"><label>Input Cost ($/M)</label><input type="number" id="editInputCost" step="0.01" required></div>
          <div class="form-group"><label>Output Cost ($/M)</label><input type="number" id="editOutputCost" step="0.01" required></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Max Output Tokens</label><input type="number" id="editMaxTokens" required></div>
          <div class="form-group"><label>Context Window</label><input type="number" id="editContextWindow" required></div>
        </div>
        <div class="button-row"><button type="submit">Save</button><button type="button" class="secondary" onclick="closeEditModal()">Cancel</button></div>
      </form>
    </div>
  </div>

  <!-- Edit API Key Modal -->
  <div class="modal" id="apiKeyModal">
    <div class="modal-content">
      <h3 id="apiKeyModalTitle">Update API Key</h3>
      <form id="apiKeyForm">
        <input type="hidden" id="apiKeyProvider">
        <div class="form-group">
          <label id="apiKeyLabel">API Key</label>
          <input type="password" id="apiKeyInput" placeholder="Enter API key...">
        </div>
        <p style="font-size:12px;color:var(--text3);margin-bottom:16px">Leave empty and save to remove the key.</p>
        <div class="button-row">
          <button type="submit">Save</button>
          <button type="button" class="secondary" onclick="closeApiKeyModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
let config=null,stats=null,apiKeys={},modelOptions={},sessionToken=localStorage.getItem('adminSession');
const providerNames={openai:'OpenAI',anthropic:'Anthropic',google:'Google',github:'GitHub'};

function showToast(m,t='success'){const e=document.getElementById('toast');e.textContent=m;e.className=`toast ${t}`;e.style.display='block';setTimeout(()=>e.style.display='none',3000)}
function fmt(n){if(n>=1e6)return(n/1e6).toFixed(2)+'M';if(n>=1e3)return(n/1e3).toFixed(1)+'K';return n.toString()}

function authHeaders(){return sessionToken?{'X-Admin-Session':sessionToken}:{}}

async function checkAuth(){
  try{
    const r=await fetch('/api/admin/auth-status',{headers:authHeaders()});
    const d=await r.json();
    
    if(d.needsPassword){
      showSetupScreen();
    }else if(!d.isAuthenticated){
      showLoginScreen();
    }else{
      showAdminPanel();
    }
  }catch(e){
    showLoginScreen();
  }
}

function showSetupScreen(){
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('adminPanel').classList.add('hidden');
  document.getElementById('loginMessage').textContent='Create an admin password';
  document.getElementById('passwordLabel').textContent='New Password';
  document.getElementById('confirmPasswordGroup').classList.remove('hidden');
  document.getElementById('loginBtn').textContent='Create Password';
  document.getElementById('loginForm').onsubmit=setupPassword;
}

function showLoginScreen(){
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('adminPanel').classList.add('hidden');
  document.getElementById('loginMessage').textContent='Enter your admin password';
  document.getElementById('passwordLabel').textContent='Password';
  document.getElementById('confirmPasswordGroup').classList.add('hidden');
  document.getElementById('loginBtn').textContent='Login';
  document.getElementById('loginForm').onsubmit=login;
}

function showAdminPanel(){
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('adminPanel').classList.remove('hidden');
  loadAll();
}

async function setupPassword(e){
  e.preventDefault();
  const pw=document.getElementById('loginPassword').value;
  const confirm=document.getElementById('confirmPassword').value;
  if(pw!==confirm){showToast('Passwords do not match','error');return}
  
  try{
    const r=await fetch('/api/admin/setup-password',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({password:pw})
    });
    const d=await r.json();
    if(d.error)throw new Error(d.error);
    sessionToken=d.sessionToken;
    localStorage.setItem('adminSession',sessionToken);
    showAdminPanel();
    showToast('Password created!');
  }catch(e){showToast(e.message,'error')}
}

async function login(e){
  e.preventDefault();
  const pw=document.getElementById('loginPassword').value;
  
  try{
    const r=await fetch('/api/admin/login',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({password:pw})
    });
    const d=await r.json();
    if(d.error)throw new Error(d.error);
    sessionToken=d.sessionToken;
    localStorage.setItem('adminSession',sessionToken);
    showAdminPanel();
    showToast('Logged in!');
  }catch(e){showToast(e.message,'error')}
}

async function logout(){
  await fetch('/api/admin/logout',{method:'POST',headers:authHeaders()});
  sessionToken=null;
  localStorage.removeItem('adminSession');
  showLoginScreen();
}

async function loadAll(){
  await Promise.all([loadConfig(),loadStats(),loadApiKeys(),loadModelOptions()]);
}

async function loadModelOptions(){
  try{
    const r=await fetch('/api/model-options',{headers:authHeaders()});
    if(!r.ok){if(r.status===401)return checkAuth();throw new Error('Failed');}
    modelOptions=await r.json();
    updateModelSyncStatus();
  }catch(e){
    console.error(e);
    document.getElementById('modelSyncStatus').textContent='Model list: unavailable';
  }
}

function latestSync(){
  const dates=Object.values(modelOptions||{}).map(v=>v?.lastSyncedAt).filter(Boolean);
  if(!dates.length)return null;
  return dates.sort().slice(-1)[0];
}

function updateModelSyncStatus(){
  const d=latestSync();
  document.getElementById('modelSyncStatus').textContent = d ? `Model list: last synced ${new Date(d).toLocaleString()}` : 'Model list: not synced yet';
}

async function syncModelOptions(){
  try{
    const r=await fetch('/api/model-options/sync',{method:'POST',headers:{...authHeaders()}});
    if(!r.ok){if(r.status===401)return checkAuth();throw new Error('Failed');}
    const d=await r.json();
    if(d.error)throw new Error(d.error);
    modelOptions=d.modelOptions||{};
    updateModelSyncStatus();
    showToast('Model options synced');
  }catch(e){showToast(e.message,'error')}
}

function populateModelIdSelect(provider,current){
  const sel=document.getElementById('editModelIdSelect');
  const list=(modelOptions?.[provider]?.models)||[];
  const options=[{id:'__custom__',displayName:'Custom (type below)'}].concat(list);
  sel.innerHTML=options.map(o=>`<option value="${o.id}">${o.displayName||o.id}</option>`).join('');
  // If current model exists in list, select it, otherwise custom
  const hasCurrent=list.some(m=>m.id===current);
  sel.value=hasCurrent?current:'__custom__';
  // If selected is a real model, reflect in input
  document.getElementById('editModelId').value=current||'';
}

document.getElementById('editModelIdSelect').addEventListener('change',()=>{
  const v=document.getElementById('editModelIdSelect').value;
  if(v&&v!=='__custom__')document.getElementById('editModelId').value=v;
});

document.getElementById('editProvider').addEventListener('change',()=>{
  const provider=document.getElementById('editProvider').value;
  populateModelIdSelect(provider,document.getElementById('editModelId').value);
});

async function loadConfig(){
  config=await(await fetch('/api/config')).json();
  renderProviderStatus();
  renderModelCards();
}

async function loadStats(){
  stats=await(await fetch('/api/stats')).json();
  renderStats();
  renderDailyChart();
  renderModelBreakdown();
}

async function loadApiKeys(){
  try{
    const r=await fetch('/api/admin/api-keys',{headers:authHeaders()});
    if(!r.ok){if(r.status===401)return checkAuth();throw new Error('Failed')}
    const d=await r.json();
    apiKeys=d.keys;
    renderApiKeys();
  }catch(e){console.error(e)}
}

async function loadModelOptions(){
  try{
    const r=await fetch('/api/model-options',{headers:authHeaders()});
    if(!r.ok){if(r.status===401)return checkAuth();throw new Error('Failed')}
    modelOptions=await r.json();
    const statusEl=document.getElementById('modelSyncStatus');
    const providers=Object.keys(modelOptions||{});
    const last=providers.map(p=>modelOptions[p]?.lastSyncedAt).filter(Boolean).sort().pop();
    statusEl.textContent=last?`Model list last synced: ${new Date(last).toLocaleString()}`:'Model list: not synced yet';
  }catch(e){
    console.error(e);
    document.getElementById('modelSyncStatus').textContent='Model list: unavailable';
  }
}

async function syncModelOptions(){
  try{
    const b=document.querySelector('button[onclick="syncModelOptions()"]');
    if(b){b.disabled=true;b.textContent='Syncing...'}
    const r=await fetch('/api/model-options/sync',{method:'POST',headers:authHeaders()});
    if(!r.ok){if(r.status===401)return checkAuth();throw new Error('Failed')}
    const d=await r.json();
    if(d.error)throw new Error(d.error);
    modelOptions=d.modelOptions||{};
    await loadModelOptions();
    showToast('Model options synced');
  }catch(e){showToast(e.message,'error')}
  finally{
    const b=document.querySelector('button[onclick="syncModelOptions()"]');
    if(b){b.disabled=false;b.textContent='Sync model options'}
  }
}

function populateModelSelect(provider,current){
  const sel=document.getElementById('editModelIdSelect');
  if(!sel)return;
  const list=(modelOptions?.[provider]?.models)||[];
  const opts=[{id:'__custom__',displayName:'Custom...'},...list];
  sel.innerHTML=opts.map(m=>`<option value="${m.id}">${m.displayName||m.id}</option>`).join('');
  // If current is in list, select it; else choose Custom...
  const has=list.some(m=>m.id===current);
  sel.value=has?current:'__custom__';
}

document.getElementById('editModelIdSelect').addEventListener('change',()=>{
  const v=document.getElementById('editModelIdSelect').value;
  if(v && v!=='__custom__') document.getElementById('editModelId').value=v;
});

document.getElementById('editProvider').addEventListener('change',()=>{
  const p=document.getElementById('editProvider').value;
  const current=document.getElementById('editModelId').value;
  populateModelSelect(p,current);
});

function renderApiKeys(){
  const c=document.getElementById('apiKeysList');
  c.innerHTML=['openai','anthropic','google','github'].map(p=>{
    const k=apiKeys[p]||{};
    return `<div class="api-key-row">
      <div class="api-key-info">
        <div class="api-key-name">${providerNames[p]}${k.source?`<span class="api-key-source ${k.source}">${k.source==='env'?'ENV VAR':'CONFIG'}</span>`:''}</div>
        <div class="api-key-value">${k.masked||'Not set'}</div>
      </div>
      <div class="api-key-status ${k.isSet&&k.connected?'connected':'disconnected'}">
        <span class="dot"></span>${k.isSet?(k.connected?'Connected':'Error'):'Missing'}
      </div>
      <div class="api-key-actions">
        <button onclick="openApiKeyModal('${p}')">${k.isSet&&k.source==='config'?'Update':'Add'}</button>
        ${k.isSet&&k.source==='config'?`<button class="danger" onclick="deleteApiKey('${p}')">Remove</button>`:''}
      </div>
    </div>`;
  }).join('');
}

function openApiKeyModal(provider){
  document.getElementById('apiKeyProvider').value=provider;
  document.getElementById('apiKeyModalTitle').textContent=`${providerNames[provider]} API Key`;
  document.getElementById('apiKeyLabel').textContent=provider==='github'?'Personal Access Token':'API Key';
  document.getElementById('apiKeyInput').value='';
  document.getElementById('apiKeyModal').classList.add('active');
}

function closeApiKeyModal(){document.getElementById('apiKeyModal').classList.remove('active')}

document.getElementById('apiKeyForm').addEventListener('submit',async e=>{
  e.preventDefault();
  const provider=document.getElementById('apiKeyProvider').value;
  const key=document.getElementById('apiKeyInput').value;
  
  try{
    const r=await fetch('/api/admin/api-keys',{
      method:'POST',
      headers:{'Content-Type':'application/json',...authHeaders()},
      body:JSON.stringify({provider,key})
    });
    if(!r.ok){if(r.status===401)return checkAuth();throw new Error('Failed')}
    const d=await r.json();
    if(d.error)throw new Error(d.error);
    closeApiKeyModal();
    showToast(key?'API key saved!':'API key removed!');
    await loadApiKeys();
    await loadConfig();
  }catch(e){showToast(e.message,'error')}
});

async function deleteApiKey(provider){
  if(!confirm(`Remove ${providerNames[provider]} API key?`))return;
  try{
    const r=await fetch(`/api/admin/api-keys/${provider}`,{method:'DELETE',headers:authHeaders()});
    if(!r.ok)throw new Error('Failed');
    showToast('API key removed');
    await loadApiKeys();
    await loadConfig();
  }catch(e){showToast(e.message,'error')}
}

function renderProviderStatus(){
  document.getElementById('providerStatus').innerHTML=[['openai','OpenAI'],['anthropic','Anthropic'],['google','Google']].map(([k,n])=>`<div class="provider-badge ${config.providers[k]?'active':'inactive'}"><span class="dot"></span>${n}</div>`).join('');
}

function renderModelCards(){
  document.getElementById('modelCards').innerHTML=Object.entries(config.models).map(([k,m])=>`<div class="card" style="cursor:pointer" onclick="openEditModal('${k}')"><div class="model-card"><div class="model-header"><span class="model-name">${m.displayName}</span><span class="model-badge ${k}">${k}</span></div><div class="model-details"><div class="model-detail"><span class="label">Provider</span><span class="value">${m.provider}</span></div><div class="model-detail"><span class="label">Model</span><span class="value">${m.model}</span></div><div class="model-detail"><span class="label">Input</span><span class="value">$${m.inputCost}/M</span></div><div class="model-detail"><span class="label">Output</span><span class="value">$${m.outputCost}/M</span></div></div></div></div>`).join('');
}

function renderStats(){
  document.getElementById('totalCost').textContent='$'+(stats.totalCost||0).toFixed(4);
  document.getElementById('totalRequests').textContent=fmt(stats.requestCount||0);
  document.getElementById('totalInputTokens').textContent=fmt(stats.totalInputTokens||0);
  document.getElementById('totalOutputTokens').textContent=fmt(stats.totalOutputTokens||0);
}

function renderDailyChart(){
  const days=[];for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);days.push(d.toISOString().split('T')[0])}
  const costs=days.map(d=>stats.dailyStats?.[d]?.cost||0);
  const max=Math.max(...costs,0.01);
  document.getElementById('dailyChart').innerHTML=days.map((d,i)=>`<div class="chart-bar" style="height:${Math.max((costs[i]/max)*100,4)}%" title="${d}: $${costs[i].toFixed(4)}"></div>`).join('');
  document.getElementById('chartLabels').innerHTML=`<span>${days[0].slice(5)}</span><span>${days[6].slice(5)}</span>`;
}

function renderModelBreakdown(){
  const c=document.getElementById('modelBreakdown');
  if(!stats.byModel||!Object.keys(stats.byModel).length){c.innerHTML='<p style="color:var(--text3)">No usage data yet</p>';return}
  c.innerHTML=Object.entries(stats.byModel).map(([k,d])=>`<div class="breakdown-row"><div class="breakdown-name">${k}</div><div class="breakdown-stats"><div class="breakdown-stat"><div class="label">Reqs</div><div>${d.requests}</div></div><div class="breakdown-stat"><div class="label">Tokens</div><div>${fmt(d.inputTokens+d.outputTokens)}</div></div><div class="breakdown-stat"><div class="label">Cost</div><div>$${d.cost.toFixed(4)}</div></div></div></div>`).join('');
}

function openEditModal(k){
  const m=config.models[k];if(!m)return;
  document.getElementById('editModelKey').value=k;
  document.getElementById('editModalTitle').textContent=`Edit ${m.displayName}`;
  document.getElementById('editDisplayName').value=m.displayName;
  document.getElementById('editProvider').value=m.provider;
  document.getElementById('editModelId').value=m.model;
  populateModelIdSelect(m.provider,m.model);
  document.getElementById('editDescription').value=m.description||'';
  document.getElementById('editInputCost').value=m.inputCost;
  document.getElementById('editOutputCost').value=m.outputCost;
  document.getElementById('editMaxTokens').value=m.maxOutputTokens;
  document.getElementById('editContextWindow').value=m.contextWindow;
  document.getElementById('editModal').classList.add('active');
}
function closeEditModal(){document.getElementById('editModal').classList.remove('active')}

document.getElementById('editModelForm').addEventListener('submit',async e=>{
  e.preventDefault();
  const k=document.getElementById('editModelKey').value;
  const u={displayName:document.getElementById('editDisplayName').value,provider:document.getElementById('editProvider').value,model:document.getElementById('editModelId').value,description:document.getElementById('editDescription').value,inputCost:parseFloat(document.getElementById('editInputCost').value),outputCost:parseFloat(document.getElementById('editOutputCost').value),maxOutputTokens:parseInt(document.getElementById('editMaxTokens').value),contextWindow:parseInt(document.getElementById('editContextWindow').value)};
  try{
    const r=await fetch('/api/config/models',{method:'POST',headers:{'Content-Type':'application/json',...authHeaders()},body:JSON.stringify({modelKey:k,updates:u})});
    if(!r.ok){if(r.status===401)return checkAuth();throw new Error('Failed')}
    const d=await r.json();
    if(d.error)throw new Error(d.error);
    config.models[k]=d.model;
    renderModelCards();
    closeEditModal();
    showToast('Model updated!');
  }catch(e){showToast(e.message,'error')}
});

document.getElementById('changePasswordForm').addEventListener('submit',async e=>{
  e.preventDefault();
  const current=document.getElementById('currentPassword').value;
  const newPw=document.getElementById('newPassword').value;
  
  try{
    const r=await fetch('/api/admin/change-password',{
      method:'POST',
      headers:{'Content-Type':'application/json',...authHeaders()},
      body:JSON.stringify({currentPassword:current,newPassword:newPw})
    });
    if(!r.ok){if(r.status===401)return checkAuth();throw new Error('Failed')}
    const d=await r.json();
    if(d.error)throw new Error(d.error);
    document.getElementById('currentPassword').value='';
    document.getElementById('newPassword').value='';
    showToast('Password updated!');
  }catch(e){showToast(e.message,'error')}
});

async function resetStats(){
  if(!confirm('Reset all stats?'))return;
  try{
    const r=await fetch('/api/stats/reset',{method:'POST',headers:authHeaders()});
    if(!r.ok){if(r.status===401)return checkAuth();throw new Error('Failed')}
    await loadStats();
    showToast('Stats reset!');
  }catch(e){showToast('Failed','error')}
}

document.getElementById('editModal').addEventListener('click',e=>{if(e.target===document.getElementById('editModal'))closeEditModal()});
document.getElementById('apiKeyModal').addEventListener('click',e=>{if(e.target===document.getElementById('apiKeyModal'))closeApiKeyModal()});

checkAuth();
</script>
</body>
</html>
