// filepath: config/public/index.html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <title>AI Code Helper</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <style>
    :root{--bg:#0d1117;--bg2:#161b22;--bg3:#21262d;--bg4:#30363d;--border:#30363d;--text:#e6edf3;--text2:#8b949e;--text3:#6e7681;--accent:#58a6ff;--green:#3fb950;--red:#f85149;--yellow:#d29922;--purple:#a371f7;--sans:'Plus Jakarta Sans',sans-serif;--mono:'JetBrains Mono',monospace}
    *{box-sizing:border-box;margin:0;padding:0}html,body{height:100%;overflow:hidden}
    body{font-family:var(--sans);background:var(--bg);color:var(--text);font-size:14px;line-height:1.5}
    .app{display:flex;height:100vh;height:100dvh}
    .sidebar{width:280px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;z-index:100}
    .sidebar-header{padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .sidebar-header h1{font-size:18px;display:flex;align-items:center;gap:8px}
    .sidebar-header h1 span{background:linear-gradient(135deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .close-sidebar{display:none;background:none;border:none;color:var(--text2);font-size:24px;cursor:pointer;padding:4px}
    .project-select{padding:12px 16px;border-bottom:1px solid var(--border)}
    .project-select label{display:block;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--text2);margin-bottom:6px}
    .project-select select{width:100%;padding:10px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--sans);font-size:14px}
    .sidebar-actions{padding:12px 16px;display:flex;flex-direction:column;gap:8px}
    .action-btn{padding:12px 16px;border:none;border-radius:8px;font-family:var(--sans);font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
    .action-btn.primary{background:var(--accent);color:var(--bg)}
    .action-btn.secondary{background:var(--bg3);color:var(--text);border:1px solid var(--border)}
    .conversations{flex:1;overflow-y:auto;padding:8px}
    .conv-item{padding:12px;border-radius:8px;cursor:pointer;margin-bottom:4px;display:flex;align-items:center;gap:8px;font-size:14px}
    .conv-item:hover{background:var(--bg4)}.conv-item.active{background:var(--bg3)}
    .conv-item .title{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .conv-item .rename-btn{display:none;background:none;border:1px solid var(--border);color:var(--text2);font-size:11px;padding:4px 8px;border-radius:6px;cursor:pointer}
    .conv-item:hover .rename-btn{display:inline-block}
    .conv-item .rename-btn:hover{background:var(--bg3);color:var(--text)}
    .sidebar-footer{padding:12px 16px;border-top:1px solid var(--border)}
    .sidebar-footer a{color:var(--text2);text-decoration:none;font-size:13px;display:flex;align-items:center;gap:6px;padding:8px 0}
    .main{flex:1;display:flex;flex-direction:column;min-width:0}
    .chat-header{padding:12px 16px;border-bottom:1px solid var(--border);background:var(--bg2);display:flex;align-items:center;gap:12px}
    .menu-btn{display:none;background:none;border:none;color:var(--text);font-size:20px;cursor:pointer;padding:4px}
    .chat-title{font-size:15px;font-weight:600;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .model-indicator{font-size:12px;color:var(--text2);display:flex;align-items:center;gap:6px;flex-shrink:0}
    .model-indicator .dot{width:6px;height:6px;border-radius:50%;background:var(--green)}
    .messages{flex:1;overflow-y:auto;padding:16px}.messages-inner{max-width:800px;margin:0 auto}
    .message{margin-bottom:20px;animation:fadeIn .3s}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1}}
    .msg-header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .msg-avatar{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;flex-shrink:0}
    .message.user .msg-avatar{background:var(--accent);color:var(--bg)}
    .message.assistant .msg-avatar{background:linear-gradient(135deg,var(--purple),var(--accent));color:#fff}
    .msg-author{font-weight:600}.msg-meta{font-size:11px;color:var(--text3)}
    .msg-content{padding-left:38px}.msg-content p{margin-bottom:12px}.msg-content p:last-child{margin-bottom:0}
    .msg-content pre{margin:12px 0;border-radius:8px;overflow:hidden}
    .msg-content pre code{display:block;padding:12px;background:var(--bg3);overflow-x:auto;font-size:13px}
    .msg-content code{font-family:var(--mono);background:var(--bg3);padding:2px 6px;border-radius:4px;font-size:13px}
    .code-header{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--bg4);font-size:12px;color:var(--text2);flex-wrap:wrap;gap:8px}
    .code-header button{background:none;border:1px solid var(--border);color:var(--text2);cursor:pointer;font-size:11px;padding:6px 10px;border-radius:4px}
    .code-header button:hover{background:var(--bg3);color:var(--text)}
    .code-header .code-left{display:flex;align-items:center;gap:8px}
    .code-header .code-caret{display:inline-block;transition:transform .15s ease;color:var(--text3)}
    details.code-block[open] .code-caret{transform:rotate(90deg)}
    details.code-block{margin:12px 0;border:1px solid var(--border);border-radius:8px;background:var(--bg2);overflow:hidden}
    details.code-block>summary{list-style:none}
    details.code-block>summary::-webkit-details-marker{display:none}
    .code-body pre{margin:0;border-radius:0}
    .code-body pre code{border-radius:0}
    .code-actions{display:flex;gap:6px}
    .code-header button.pr-btn{border-color:var(--green);color:var(--green)}
    .code-header button.pr-btn:hover{background:rgba(63,185,80,0.15)}
    .code-header button:disabled{opacity:0.5;cursor:not-allowed}
    .input-area{padding:12px 16px;border-top:1px solid var(--border);background:var(--bg2)}
    .input-inner{max-width:800px;margin:0 auto}
    .model-toggle{display:flex;gap:4px;margin-bottom:10px;background:var(--bg3);padding:4px;border-radius:8px;width:fit-content}
    .model-toggle button{padding:8px 14px;background:none;border:none;color:var(--text2);font-family:var(--sans);font-size:13px;font-weight:500;cursor:pointer;border-radius:6px}
    .model-toggle button.active{background:var(--bg4);color:var(--text)}
    .input-box{position:relative}
    .input-box textarea{width:100%;padding:14px 16px;padding-right:90px;background:var(--bg3);border:1px solid var(--border);border-radius:12px;color:var(--text);font-family:var(--sans);font-size:15px;resize:none;min-height:52px;max-height:150px}
    .input-actions{position:absolute;right:8px;bottom:8px;display:flex;gap:6px}
    .input-actions button{padding:10px 16px;background:var(--accent);border:none;border-radius:6px;color:var(--bg);font-weight:600;cursor:pointer;font-size:14px}
    .input-actions button.attach{background:transparent;color:var(--text2);padding:10px}
    .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000;padding:16px}
    .modal.active{display:flex}
    .modal-content{background:var(--bg2);border:1px solid var(--border);border-radius:12px;width:100%;max-width:600px;max-height:80vh;display:flex;flex-direction:column}
    .modal-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .modal-body{flex:1;overflow-y:auto;padding:16px 20px}
    .file-tree{font-family:var(--mono);font-size:13px}
    .file-item{padding:10px;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:8px}
    .file-item:hover{background:var(--bg4)}
    .file-item.selected{background:rgba(88,166,255,.15);color:var(--accent)}
    .toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);padding:12px 20px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;display:none;z-index:2000}
    .streaming-dot{width:6px;height:6px;background:var(--accent);border-radius:50%;animation:pulse 1.5s infinite;display:inline-block}
    @keyframes pulse{0%,100%{opacity:.4}50%{opacity:1}}
  </style>
</head>
<body>
  <div class="toast" id="toast"></div>
  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header"><h1>‚ö° <span>AI Code Helper</span></h1></div>
      <div class="project-select"><label>Project</label><select id="projectSelect"><option value="">No project</option></select></div>
      <div class="sidebar-actions">
        <button class="action-btn primary" id="newChatBtn">üí¨ New Chat</button>
      </div>
      <div class="conversations" id="conversations"></div>
      <div class="sidebar-footer"><a href="/admin">‚öôÔ∏è Admin</a></div>
    </aside>
    <main class="main">
      <header class="chat-header">
        <button class="menu-btn" id="menuBtn">‚ò∞</button>
        <span class="chat-title" id="chatTitle">New conversation</span>
        <span class="model-indicator" id="modelIndicator"><span class="dot"></span>Ready</span>
      </header>
      <div class="messages" id="messages"><div class="messages-inner" id="messagesInner"></div></div>
      <div class="input-area">
        <div class="input-inner">
          <div class="model-toggle" id="modelToggle">
            <button class="active" data-mode="auto">üîÄ Auto</button>
            <button data-mode="fast">‚ö° Fast</button>
            <button data-mode="full">üî• Full</button>
          </div>
          <div class="file-chips" id="fileChips"></div>
          <div class="input-box">
            <textarea id="messageInput" placeholder="Describe what you want to build..." rows="1"></textarea>
            <div class="input-actions">
              <button class="attach" id="attachBtn">üìé</button>
              <button id="sendBtn">Send</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <div class="modal" id="fileModal">
    <div class="modal-content">
      <div class="modal-header"><h3>üìÅ Add files</h3><button class="modal-close" id="closeFileModal">√ó</button></div>
      <div class="modal-body"><input type="text" class="file-search" id="fileSearch" placeholder="Search..."><div class="file-tree" id="fileTree"></div></div>
      <div class="modal-footer"><button id="confirmFiles">Add Selected</button></div>
    </div>
  </div>

<script>
marked.setOptions({highlight:(c,l)=>l&&hljs.getLanguage(l)?hljs.highlight(c,{language:l}).value:hljs.highlightAuto(c).value,breaks:true});
const state={conversationId:null,conversations:[],loadedFiles:[],repoFiles:[],selectedFiles:new Set(),config:null,mode:'auto',streaming:false};
const $=id=>document.getElementById(id);
function escapeHtml(s){return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;')}
function showToast(m){const e=$('toast');e.textContent=m;e.style.display='block';setTimeout(()=>e.style.display='none',3000)}

async function loadConfig(){
  try{
    const resp=await fetch('/api/config');
    if(!resp.ok) throw new Error(`Server returned ${resp.status}`);
    state.config=await resp.json();
  }catch(e){
    console.warn('Failed to load /api/config:',e);
    state.config=null;
  }
}
async function loadProjects(){try{const r=await(await fetch('/api/projects')).json();$('projectSelect').innerHTML='<option value="">No project</option>'+r.map(x=>`<option value="${x.fullName}">${x.fullName}</option>`).join('')}catch(e){}}
async function loadConversations(){state.conversations=await(await fetch('/api/conversations')).json();renderConversations()}

async function renameConversation(id,title){
  try{
    const resp=await fetch(`/api/conversations/${encodeURIComponent(id)}`,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({title})});
    if(!resp.ok){const t=await resp.text().catch(()=>'' );throw new Error(`Server returned ${resp.status}: ${t}`)}
    await loadConversations();
    const c=state.conversations.find(x=>x.id===id);
    if(c && c.id===state.conversationId){$('chatTitle').textContent=c.title||'Conversation'}
    showToast('Renamed');
  }catch(e){
    console.error('Rename failed:',e);
    showToast('Rename failed');
  }
}

function renderConversations(){
  $('conversations').innerHTML=state.conversations.map(c=>`
    <div class="conv-item${c.id===state.conversationId?' active':''}" data-id="${c.id}">
      <span class="title">${escapeHtml(c.title||'Chat')}</span>
      <button class="rename-btn" title="Rename">‚úé</button>
    </div>
  `).join('');

  $('conversations').querySelectorAll('.conv-item').forEach(el=>{
    const id=el.dataset.id;
    el.onclick=()=>loadConversation(id);

    const rb=el.querySelector('.rename-btn');
    rb.onclick=(ev)=>{
      ev.stopPropagation();
      const current=(state.conversations.find(x=>x.id===id)?.title)||'';
      const next=prompt('Rename chat:', current);
      if(next===null) return;
      const title=next.trim();
      if(!title){showToast('Title cannot be blank');return;}
      renameConversation(id,title);
    };
  });
}

async function loadConversation(id){
  const c=state.conversations.find(x=>x.id===id);if(!c)return;
  state.conversationId=id;
  $('chatTitle').textContent=c.title||'Conversation';
  if(c.repoFullName){$('projectSelect').value=c.repoFullName;await loadRepoFiles()}
  renderMessages(c.messages);renderConversations();
}

function renderMessages(msgs){
  $('messagesInner').innerHTML='';
  msgs.forEach(m=>appendMessage(m.role,m.content,m.model,false));
  $('messages').scrollTop=$('messages').scrollHeight;
}

function detectFilePath(codeText){
  const head=(codeText||'').split(/\r?\n/).slice(0,6).join('\n');
  const m=head.match(/filepath:\s*([^\n\r]+)/i);
  if(!m) return null;
  let p=m[1].trim();
  p=p.replace(/\*\/\s*$/,'').replace(/-->\s*$/,'').trim();
  p=p.replace(/^['"`]+|['"`]+$/g,'');
  return p||null;
}

function stripFilePathHeader(codeText){
  const lines=String(codeText||'').split(/\r?\n/);
  let i=0;
  while(i<Math.min(lines.length,6) && lines[i].trim()==='') i++;
  if(i<lines.length && /filepath:\s*/i.test(lines[i]) && /^\s*(?:\/\/|#|;|--|\/\*|\*|<!--)/.test(lines[i])){
    lines.splice(i,1);
    if(i<lines.length && lines[i].trim()==='') lines.splice(i,1);
  }
  return lines.join('\n');
}

async function createDraftPr({filePath,content,buttonEl}){
  const repoFullName=$('projectSelect').value;
  if(!repoFullName){showToast('Select a project first');return;}

  const payload={
    repoFullName,
    conversationId: state.conversationId || 'new',
    filePath,
    content: stripFilePathHeader(content)
  };

  const prevText=buttonEl?buttonEl.textContent:'';
  if(buttonEl){buttonEl.disabled=true;buttonEl.textContent='Creating...';}
  try{
    const resp=await fetch('/api/pr/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!resp.ok){const t=await resp.text().catch(()=>'' );throw new Error(`Server returned ${resp.status}: ${t}`)}
    const d=await resp.json();
    if(d.prUrl){showToast('Draft PR created');window.open(d.prUrl,'_blank');}
    else showToast('PR created');
  }catch(e){
    console.error('Create PR failed:',e);
    showToast('Create PR failed');
  }finally{
    if(buttonEl){buttonEl.disabled=false;buttonEl.textContent=prevText||'Create PR';}
  }
}

function enhanceCodeBlocks(container){
  container.querySelectorAll('pre > code').forEach((codeEl)=>{
    const pre=codeEl.parentElement;
    if(!pre || pre.closest('details.code-block')) return;
    const codeText=codeEl.textContent||'';
    const filePath=detectFilePath(codeText);
    const lang=(codeEl.className.match(/language-([A-Za-z0-9_-]+)/)||[])[1]||'text';
    const label=filePath||lang.toUpperCase();

    const details=document.createElement('details');
    details.className='code-block';
    const summary=document.createElement('summary');
    summary.innerHTML=`<div class="code-header"><div class="code-left"><span class="code-caret">‚ñ∂</span><span class="code-lang">${escapeHtml(label)}</span></div><div class="code-actions"><button type="button" class="copy-btn">Copy</button><button type="button" class="apply-btn pr-btn"${filePath?'':' disabled'}>Create PR</button></div></div>`;
    const body=document.createElement('div');
    body.className='code-body';

    pre.parentNode.replaceChild(details, pre);
    details.appendChild(summary);
    details.appendChild(body);
    body.appendChild(pre);

    // Avoid toggling the <details> when clicking buttons
    summary.querySelectorAll('button').forEach(btn=>btn.addEventListener('click', ev=>ev.stopPropagation()));

    const copyBtn=summary.querySelector('.copy-btn');
    copyBtn.onclick=async (ev)=>{
      ev.stopPropagation();
      try{await navigator.clipboard.writeText(codeText);showToast('Copied');}
      catch{showToast('Copy failed');}
    };

    const prBtn=summary.querySelector('.pr-btn');
    prBtn.onclick=(ev)=>{
      ev.stopPropagation();
      if(!filePath) return;
      createDraftPr({filePath,content:codeText,buttonEl:prBtn});
    };
  });
}

function renderMarkdownInto(el,markdown){
  el.innerHTML=marked.parse(markdown||'');
  // Ensure highlighting for any blocks that were inserted without highlight classes.
  el.querySelectorAll('pre code').forEach((block)=>{try{hljs.highlightElement(block);}catch{}});
  enhanceCodeBlocks(el);
}

function appendMessage(role,content,model='',animate=true){
  const msg=document.createElement('div');msg.className=`message ${role}`;
  msg.innerHTML=`<div class="msg-header"><div class="msg-avatar">${role==='user'?'Y':'AI'}</div><span class="msg-author">${role==='user'?'You':'Assistant'}</span><span class="msg-meta">${model}</span></div><div class="msg-content"></div>`;
  const cel=msg.querySelector('.msg-content');
  if(role==='assistant'){
    renderMarkdownInto(cel, content);
  }else{
    cel.innerHTML=`<p>${escapeHtml(content)}</p>`;
  }
  $('messagesInner').appendChild(msg);return msg;
}

// FIXED: Handles the new backend contract and reports errors
async function loadRepoFiles(){
  const r=$('projectSelect').value;
  if(!r){state.repoFiles=[];return}
  try {
    const[o,n]=r.split('/');
    const resp = await fetch(`/api/projects/${o}/${n}/files`);
    if(!resp.ok) throw new Error(`Server returned ${resp.status}`);
    const d=await resp.json();
    state.repoFiles=d.files||[];
    console.log(`Loaded ${state.repoFiles.length} files from ${r}`);
  } catch(e) {
    console.error("Failed to load repo files:", e);
    showToast("Error loading file list");
    state.repoFiles=[];
  }
}

$('projectSelect').onchange=loadRepoFiles;
$('attachBtn').onclick=()=>{if(!$('projectSelect').value){showToast('Select project first');return}renderFileTree();$('fileModal').classList.add('active')};

function renderFileTree(f=''){
  const fl=state.repoFiles.filter(x=>x.toLowerCase().includes(f.toLowerCase()));
  $('fileTree').innerHTML=fl.slice(0,100).map(x=>`<div class="file-item${state.selectedFiles.has(x)?' selected':''}" data-path="${x}">üìÑ ${x}</div>`).join('');
  $('fileTree').querySelectorAll('.file-item').forEach(e=>e.onclick=()=>{
    const p=e.dataset.path;
    if(state.selectedFiles.has(p)){state.selectedFiles.delete(p);e.classList.remove('selected')}
    else{state.selectedFiles.add(p);e.classList.add('selected')}
  });
}

$('fileSearch').oninput=e=>renderFileTree(e.target.value);
$('closeFileModal').onclick=()=>$('fileModal').classList.remove('active');
$('confirmFiles').onclick=()=>{state.loadedFiles=Array.from(state.selectedFiles);$('fileModal').classList.remove('active')};

async function sendMessage(){
  const m=$('messageInput').value.trim();if(!m||state.streaming)return;
  state.streaming=true;$('sendBtn').disabled=true;
  appendMessage('user',m);$('messageInput').value='';
  const aMsg=appendMessage('assistant','');const cel=aMsg.querySelector('.msg-content');cel.innerHTML='<span class="streaming-dot"></span>';
  try{
    const res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({conversationId:state.conversationId,message:m,repoFullName:$('projectSelect').value,loadedFiles:state.loadedFiles,modelOverride:state.mode})});
    const reader=res.body.getReader();const dec=new TextDecoder();let full='';
    while(true){const{done,value}=await reader.read();if(done)break;
      for(const line of dec.decode(value).split('\n')){if(!line.startsWith('data: '))continue;
        try{const d=JSON.parse(line.slice(6));
          if(d.type==='start'){state.conversationId=d.conversationId;$('modelIndicator').innerHTML=`<span class="dot"></span>${d.model}`}
          else if(d.type==='text'){full+=d.text;cel.innerHTML=marked.parse(full);$('messages').scrollTop=$('messages').scrollHeight}
          else if(d.type==='done'){loadConversations()}
        }catch(e){}}
    }

    // Final render pass adds collapsible code blocks + Copy/Create PR buttons
    if(full) renderMarkdownInto(cel, full);
  }catch(e){cel.innerHTML='Error sending message'}
  finally{state.streaming=false;$('sendBtn').disabled=false}
}

$('sendBtn').onclick=sendMessage;
$('newChatBtn').onclick=()=>{state.conversationId=null;state.loadedFiles=[];renderMessages([]);$('chatTitle').textContent='New Chat'};
loadConfig();loadProjects();loadConversations();
</script>
</body>
</html>
