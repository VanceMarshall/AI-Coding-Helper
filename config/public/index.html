<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <title>AI Code Helper</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <style>
    :root{--bg:#0d1117;--bg2:#161b22;--bg3:#21262d;--bg4:#30363d;--border:#30363d;--text:#e6edf3;--text2:#8b949e;--text3:#6e7681;--accent:#58a6ff;--green:#3fb950;--red:#f85149;--yellow:#d29922;--purple:#a371f7;--sans:'Plus Jakarta Sans',sans-serif;--mono:'JetBrains Mono',monospace}
    *{box-sizing:border-box;margin:0;padding:0}html,body{height:100%;overflow:hidden}
    body{font-family:var(--sans);background:var(--bg);color:var(--text);font-size:14px;line-height:1.5}
    .app{display:flex;height:100vh;height:100dvh}
    .sidebar{width:280px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;z-index:100}
    .sidebar-header{padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .sidebar-header h1{font-size:18px;display:flex;align-items:center;gap:8px}
    .sidebar-header h1 span{background:linear-gradient(135deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .close-sidebar{display:none;background:none;border:none;color:var(--text2);font-size:24px;cursor:pointer;padding:4px}
    .project-select{padding:12px 16px;border-bottom:1px solid var(--border)}
    .project-select label{display:block;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--text2);margin-bottom:6px}
    .project-select select{width:100%;padding:10px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--sans);font-size:14px}
    .sidebar-actions{padding:12px 16px;display:flex;flex-direction:column;gap:8px}
    .action-btn{padding:12px 16px;border:none;border-radius:8px;font-family:var(--sans);font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
    .action-btn.primary{background:var(--accent);color:var(--bg)}
    .action-btn.secondary{background:var(--bg3);color:var(--text);border:1px solid var(--border)}
    .action-btn:hover{opacity:0.9}
    .conversations{flex:1;overflow-y:auto;padding:8px}
    .conv-item{padding:12px;border-radius:8px;cursor:pointer;margin-bottom:4px;display:flex;align-items:center;gap:8px;font-size:14px}
    .conv-item:hover{background:var(--bg4)}.conv-item.active{background:var(--bg3)}
    .conv-item .title{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .conv-item .type-badge{font-size:10px;padding:2px 6px;border-radius:4px;background:var(--bg4);color:var(--text3)}
    .conv-item .type-badge.planning{background:rgba(210,153,34,0.2);color:var(--yellow)}
    .sidebar-footer{padding:12px 16px;border-top:1px solid var(--border)}
    .sidebar-footer a{color:var(--text2);text-decoration:none;font-size:13px;display:flex;align-items:center;gap:6px;padding:8px 0}
    .sidebar-footer a:hover{color:var(--text)}
    .main{flex:1;display:flex;flex-direction:column;min-width:0}
    .chat-header{padding:12px 16px;border-bottom:1px solid var(--border);background:var(--bg2);display:flex;align-items:center;gap:12px}
    .menu-btn{display:none;background:none;border:none;color:var(--text);font-size:20px;cursor:pointer;padding:4px}
    .chat-title{font-size:15px;font-weight:600;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .model-indicator{font-size:12px;color:var(--text2);display:flex;align-items:center;gap:6px;flex-shrink:0}
    .model-indicator .dot{width:6px;height:6px;border-radius:50%;background:var(--green)}
    .messages{flex:1;overflow-y:auto;padding:16px}.messages-inner{max-width:800px;margin:0 auto}
    .message{margin-bottom:20px;animation:fadeIn .3s}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1}}
    .msg-header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .msg-avatar{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;flex-shrink:0}
    .message.user .msg-avatar{background:var(--accent);color:var(--bg)}
    .message.assistant .msg-avatar{background:linear-gradient(135deg,var(--purple),var(--accent));color:#fff}
    .msg-author{font-weight:600}.msg-meta{font-size:11px;color:var(--text3)}
    .msg-content{padding-left:38px}.msg-content p{margin-bottom:12px}.msg-content p:last-child{margin-bottom:0}
    .msg-content pre{margin:12px 0;border-radius:8px;overflow:hidden}
    .msg-content pre code{display:block;padding:12px;background:var(--bg3);overflow-x:auto;font-size:13px}
    .msg-content code{font-family:var(--mono);background:var(--bg3);padding:2px 6px;border-radius:4px;font-size:13px}
    .msg-content ul,.msg-content ol{margin:12px 0;padding-left:24px}.msg-content li{margin-bottom:6px}
    .msg-content h2,.msg-content h3{margin:16px 0 8px;color:var(--text)}
    .msg-content strong{color:var(--text)}
    .msg-content hr{border:none;border-top:1px solid var(--border);margin:16px 0}
    .code-header{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--bg4);font-size:12px;color:var(--text2);flex-wrap:wrap;gap:8px}
    .code-header .code-lang{font-weight:500}
    .code-header .code-actions{display:flex;gap:6px}
    .code-header button{background:none;border:1px solid var(--border);color:var(--text2);cursor:pointer;font-size:11px;padding:6px 10px;border-radius:4px;font-family:var(--sans)}
    .code-header button:hover{background:var(--bg3);color:var(--text);border-color:var(--text3)}
    .code-header button.apply-btn{border-color:var(--green);color:var(--green)}
    .code-header button.apply-btn:hover{background:rgba(63,185,80,0.15)}
    .code-header button.applied{border-color:var(--green);background:rgba(63,185,80,0.15);color:var(--green)}
    .code-header button:disabled{opacity:0.5;cursor:not-allowed}
/* Collapsible code blocks */
details.code-block{margin:12px 0;border:1px solid var(--border);border-radius:8px;background:var(--bg2);overflow:hidden}
details.code-block>summary{list-style:none}
details.code-block>summary::-webkit-details-marker{display:none}
details.code-block>summary::marker{content:''}
.code-left{display:flex;align-items:center;gap:8px}
.code-caret{display:inline-block;transition:transform .15s ease;color:var(--text3)}
details.code-block[open] .code-caret{transform:rotate(90deg)}
.code-body pre{margin:0;border-radius:0}
.code-body pre code{border-radius:0}
.code-block .code-header{border:none;border-bottom:1px solid var(--border);border-radius:0;cursor:pointer}
.code-block .code-actions button{cursor:pointer}

    .empty-state{text-align:center;padding:40px 20px;color:var(--text2)}
    .empty-state h2{font-size:22px;color:var(--text);margin-bottom:8px}
    .empty-state p{margin-bottom:20px;max-width:400px;margin-left:auto;margin-right:auto}
    .empty-actions{display:flex;flex-direction:column;align-items:center;gap:10px;margin-bottom:24px}
    .empty-actions button{padding:14px 28px;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;width:100%;max-width:260px;justify-content:center}
    .empty-actions .primary{background:var(--accent);color:var(--bg);border:none}
    .empty-actions .secondary{background:var(--bg3);color:var(--text);border:1px solid var(--border)}
    .suggestions{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin-top:20px}
    .suggestion{padding:10px 16px;background:var(--bg3);border:1px solid var(--border);border-radius:20px;font-size:14px;cursor:pointer;color:var(--text)}
    .suggestion:hover{border-color:var(--accent);color:var(--accent)}
    .input-area{padding:12px 16px;border-top:1px solid var(--border);background:var(--bg2)}
    .input-inner{max-width:800px;margin:0 auto}
    .mode-indicator{display:flex;align-items:center;gap:8px;margin-bottom:10px;font-size:12px;color:var(--text2)}
    .mode-indicator .mode-badge{padding:4px 10px;border-radius:12px;font-weight:500}
    .mode-indicator .mode-badge.planning{background:rgba(210,153,34,0.2);color:var(--yellow)}
    .mode-indicator .mode-badge.building{background:rgba(88,166,255,0.2);color:var(--accent)}
    .model-toggle{display:flex;gap:4px;margin-bottom:10px;background:var(--bg3);padding:4px;border-radius:8px;width:fit-content}
    .model-toggle button{padding:8px 14px;background:none;border:none;color:var(--text2);font-family:var(--sans);font-size:13px;font-weight:500;cursor:pointer;border-radius:6px}
    .model-toggle button.active{background:var(--bg4);color:var(--text)}
    .model-toggle button.active[data-mode=auto]{color:var(--yellow)}
    .model-toggle button.active[data-mode=fast]{color:var(--green)}
    .model-toggle button.active[data-mode=full]{color:var(--accent)}
    .route-preview{font-size:11px;color:var(--text3);margin-bottom:8px;min-height:16px}
    .file-chips{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px}
    .file-chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;background:var(--bg3);border:1px solid var(--border);border-radius:16px;font-size:12px;font-family:var(--mono)}
    .file-chip button{background:none;border:none;color:var(--text3);cursor:pointer;font-size:14px;padding:0 2px}
    .file-chip button:hover{color:var(--red)}
    .input-box{position:relative}
    .input-box textarea{width:100%;padding:14px 16px;padding-right:90px;background:var(--bg3);border:1px solid var(--border);border-radius:12px;color:var(--text);font-family:var(--sans);font-size:15px;resize:none;min-height:52px;max-height:150px}
    .input-box textarea:focus{outline:none;border-color:var(--accent)}
    .input-box textarea::placeholder{color:var(--text3)}
    .input-actions{position:absolute;right:8px;bottom:8px;display:flex;gap:6px}
    .input-actions button{padding:10px 16px;background:var(--accent);border:none;border-radius:6px;color:var(--bg);font-weight:600;cursor:pointer;font-size:14px}
    .input-actions button:disabled{opacity:.5;cursor:not-allowed}
    .input-actions button.attach{background:transparent;color:var(--text2);padding:10px}
    .input-hint{margin-top:8px;font-size:11px;color:var(--text3);display:flex;justify-content:space-between}
    .cost-display{font-family:var(--mono)}
    .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000;padding:16px}
    .modal.active{display:flex}
    .modal-content{background:var(--bg2);border:1px solid var(--border);border-radius:12px;width:100%;max-width:600px;max-height:80vh;display:flex;flex-direction:column}
    .modal-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .modal-header h3{font-size:16px}
    .modal-close{background:none;border:none;color:var(--text2);font-size:24px;cursor:pointer;padding:4px}
    .modal-body{flex:1;overflow-y:auto;padding:16px 20px}
    .file-search{width:100%;padding:12px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:15px;margin-bottom:12px}
    .file-tree{font-family:var(--mono);font-size:13px}
    .file-item{padding:10px;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:8px}
    .file-item:hover{background:var(--bg4)}
    .file-item.selected{background:rgba(88,166,255,.15);color:var(--accent)}
    .modal-footer{padding:12px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px}
    .modal-footer button{padding:10px 20px;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer}
    .btn-secondary{background:var(--bg3);border:1px solid var(--border);color:var(--text)}
    .btn-primary{background:var(--accent);border:none;color:var(--bg)}
    .toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);padding:12px 20px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;display:none;z-index:2000;max-width:90%;text-align:center}
    .toast.success{border-left:3px solid var(--green)}.toast.error{border-left:3px solid var(--red)}
    .streaming-dot{width:6px;height:6px;background:var(--accent);border-radius:50%;animation:pulse 1.5s infinite;display:inline-block}
    @keyframes pulse{0%,100%{opacity:.4}50%{opacity:1}}
    .sidebar-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:99}
    ::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
    
    /* Mobile Responsive */
    @media(max-width:768px){
      .sidebar{position:fixed;top:0;left:0;bottom:0;transform:translateX(-100%);transition:transform .3s ease;width:85%;max-width:320px}
      .sidebar.open{transform:translateX(0)}
      .sidebar-overlay.open{display:block}
      .close-sidebar{display:block}
      .menu-btn{display:block}
      .chat-header{padding:12px}
      .messages{padding:12px}
      .msg-content{padding-left:0;margin-top:8px}
      .msg-header{flex-wrap:wrap}
      .input-area{padding:10px 12px}
      .model-toggle{width:100%;justify-content:center}
      .model-toggle button{flex:1;padding:10px 8px;font-size:12px}
      .input-box textarea{font-size:16px;padding-right:80px}
      .input-hint{display:none}
      .empty-state{padding:30px 16px}
      .empty-state h2{font-size:20px}
      .code-header{flex-direction:column;align-items:flex-start}
      .code-header .code-actions{width:100%;justify-content:flex-end}
    }
  </style>
</head>
<body>
  <div class="toast" id="toast"></div>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h1>‚ö° <span>AI Code Helper</span></h1>
        <button class="close-sidebar" id="closeSidebar">√ó</button>
      </div>
      <div class="project-select"><label>Project</label><select id="projectSelect"><option value="">No project selected</option></select></div>
      <div class="sidebar-actions">
        <button class="action-btn primary" id="newProjectBtn">üöÄ New Project</button>
        <button class="action-btn secondary" id="newChatBtn">üí¨ New Chat</button>
      </div>
      <div class="conversations" id="conversations"></div>
      <div class="sidebar-footer"><a href="/admin">‚öôÔ∏è Admin Panel</a></div>
    </aside>
    <main class="main">
      <header class="chat-header">
        <button class="menu-btn" id="menuBtn">‚ò∞</button>
        <span class="chat-title" id="chatTitle">New conversation</span>
        <span class="model-indicator" id="modelIndicator"><span class="dot"></span>Ready</span>
      </header>
      <div class="messages" id="messages">
        <div class="messages-inner" id="messagesInner">
          <div class="empty-state" id="emptyState">
            <h2>What would you like to build?</h2>
            <p>Start a new project from scratch, or work on an existing one.</p>
            <div class="empty-actions">
              <button class="primary" id="emptyNewProject">üöÄ Start New Project</button>
              <button class="secondary" id="emptySelectProject">üìÇ Open Existing</button>
            </div>
            <p style="font-size:13px;color:var(--text3)">Or ask me anything:</p>
            <div class="suggestions">
              <button class="suggestion" data-text="Help me refactor this code">Refactor code</button>
              <button class="suggestion" data-text="Debug this error">Debug error</button>
              <button class="suggestion" data-text="Review my code">Code review</button>
            </div>
          </div>
        </div>
      </div>
      <div class="input-area">
        <div class="input-inner">
          <div class="mode-indicator" id="modeIndicator" style="display:none">
            <span>Mode:</span>
            <span class="mode-badge planning" id="modeBadge">Planning</span>
          </div>
          <div class="model-toggle" id="modelToggle">
            <button class="active" data-mode="auto">üîÄ Auto</button>
            <button data-mode="fast">‚ö° Fast</button>
            <button data-mode="full">üî• Full</button>
          </div>
          <div class="route-preview" id="routePreview">Auto mode: Type to see which model</div>
          <div class="file-chips" id="fileChips"></div>
          <div class="input-box">
            <textarea id="messageInput" placeholder="Describe what you want to build..." rows="1"></textarea>
            <div class="input-actions">
              <button class="attach" id="attachBtn">üìé</button>
              <button id="sendBtn">Send</button>
            </div>
          </div>
          <div class="input-hint"><span>Ctrl+Enter to send</span><span class="cost-display" id="costDisplay"></span></div>
        </div>
      </div>
    </main>
  </div>
  <div class="modal" id="fileModal">
    <div class="modal-content">
      <div class="modal-header"><h3>üìÅ Add files</h3><button class="modal-close" id="closeFileModal">√ó</button></div>
      <div class="modal-body"><input type="text" class="file-search" id="fileSearch" placeholder="Search..."><div class="file-tree" id="fileTree"></div></div>
      <div class="modal-footer"><button class="btn-secondary" id="cancelFiles">Cancel</button><button class="btn-primary" id="confirmFiles">Add</button></div>
    </div>
  </div>

  <div class="modal" id="patchModal">
    <div class="modal-content" style="max-width:900px">
      <div class="modal-header">
        <h3>üß© Patch Preview</h3>
        <button class="modal-close" id="closePatchModal">√ó</button>
      </div>
      <div class="modal-body">
        <div class="patch-grid" id="patchList"></div>

        <div class="patch-controls">
          <label><input type="checkbox" id="allowPartialEdits"> Allow partial edits (unsafe)</label>
        </div>
        <div class="patch-small">
          Safety rules: by default, each selected code block must represent a full file. If a block looks like a diff or partial snippet, we will refuse unless you enable "Allow partial edits".
          We also refuse suspicious file paths (absolute paths, traversal, .git/).
        </div>

        <div style="margin-top:14px">
          <input type="text" id="prTitle" class="file-search" placeholder="PR title (optional)">
          <textarea id="prBody" class="file-search" placeholder="PR description (optional)" style="height:90px;resize:vertical"></textarea>
        </div>
      </div>
      <div class="modal-footer patch-actions">
        <button class="btn-secondary" id="cancelPatch">Cancel</button>
        <button class="btn-primary" id="createPrBtn">Create Draft PR</button>
      </div>
    </div>
  </div>
<script>

marked.setOptions({highlight:(c,l)=>l&&hljs.getLanguage(l)?hljs.highlight(c,{language:l}).value:hljs.highlightAuto(c).value,breaks:true,gfm:true});
const state={conversationId:null,conversations:[],loadedFiles:[],repoFiles:[],selectedFiles:new Set(),config:null,mode:'auto',chatMode:'building',totalCost:0,streaming:false};
const $=id=>document.getElementById(id);
function showToast(m,t='success'){const e=$('toast');e.textContent=m;e.className=`toast ${t}`;e.style.display='block';setTimeout(()=>e.style.display='none',4000)}
function escapeHtml(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}

// Sidebar toggle
function openSidebar(){$('sidebar').classList.add('open');$('sidebarOverlay').classList.add('open')}
function closeSidebar(){$('sidebar').classList.remove('open');$('sidebarOverlay').classList.remove('open')}
$('menuBtn').onclick=openSidebar;
$('closeSidebar').onclick=closeSidebar;
$('sidebarOverlay').onclick=closeSidebar;

async function loadConfig(){state.config=await(await fetch('/api/config')).json()}
async function loadProjects(){try{const r=await(await fetch('/api/projects')).json();$('projectSelect').innerHTML='<option value="">No project</option>'+r.map(x=>`<option value="${x.fullName}">${x.fullName}</option>`).join('')}catch(e){}}
async function loadConversations(){state.conversations=await(await fetch('/api/conversations')).json();renderConversations()}

function renderConversations(){
  $('conversations').innerHTML=state.conversations.length?state.conversations.map(c=>`<div class="conv-item${c.id===state.conversationId?' active':''}" data-id="${c.id}"><span>${c.type==='planning'?'üöÄ':'üí¨'}</span><span class="title">${escapeHtml(c.title)}</span>${c.type==='planning'?'<span class="type-badge planning">Plan</span>':''}</div>`).join(''):'<div style="padding:20px;text-align:center;color:var(--text3);font-size:13px">No chats yet</div>';
  $('conversations').querySelectorAll('.conv-item').forEach(el=>el.onclick=()=>{loadConversation(el.dataset.id);closeSidebar()});
}

async function loadConversation(id){
  const c=state.conversations.find(x=>x.id===id);if(!c)return;
  state.conversationId=id;
  state.chatMode=c.type||'building';
  updateModeIndicator();
  $('chatTitle').textContent=c.title;
  if(c.repoFullName){$('projectSelect').value=c.repoFullName;await loadRepoFiles()}
  renderMessages(c.messages);renderConversations();
}

function updateModeIndicator(){
  if(state.chatMode==='planning'){
    $('modeIndicator').style.display='flex';
    $('modeBadge').textContent='Planning';
    $('modeBadge').className='mode-badge planning';
    $('messageInput').placeholder='Describe what you want to build...';
  }else{
    $('modeIndicator').style.display='none';
    $('messageInput').placeholder='Ask me anything...';
  }
}

function renderMessages(msgs){
  if(!msgs?.length){$('emptyState').style.display='block';Array.from($('messagesInner').children).forEach(c=>{if(c!==$('emptyState'))c.remove()});return}
  $('emptyState').style.display='none';
  Array.from($('messagesInner').children).forEach(c=>{if(c!==$('emptyState'))c.remove()});
  msgs.forEach(m=>appendMessage(m.role,m.content,m.model,false));
  $('messages').scrollTop=$('messages').scrollHeight;
}

function appendMessage(role,content,model='',animate=true){
  $('emptyState').style.display='none';
  const msg=document.createElement('div');msg.className=`message ${role}`;if(!animate)msg.style.animation='none';
  const time=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  msg.innerHTML=`<div class="msg-header"><div class="msg-avatar">${role==='user'?'Y':'AI'}</div><span class="msg-author">${role==='user'?'You':'Assistant'}</span><span class="msg-meta">${time}${model?' ¬∑ '+model:''}</span></div><div class="msg-content"></div>`;
  const cel=msg.querySelector('.msg-content');
  if(role==='assistant'){cel.innerHTML=renderMarkdown(content)}else{cel.innerHTML=`<p>${escapeHtml(content)}</p>`}
  $('messagesInner').appendChild(msg);return msg;
}

function extractFilePathMeta(code,lang){
  const lines=String(code||'').split('\n').slice(0,8);
  const patterns=[
    /^\s*(?:\/\/|#|<!--|;|--|\*|\/\*+)\s*(?:file|filepath|path)\s*:\s*([^\s]+)\s*/i,
    /^\s*<!--\s*(?:file|filepath|path)\s*:\s*([^\s]+)\s*-->\s*$/i
  ];
  for(const line of lines){
    for(const p of patterns){
      const m=line.match(p);
      if(m&&m[1]) return {path:m[1].trim(),explicit:true};
    }
  }
  const map={'javascript':'script.js','js':'script.js','typescript':'script.ts','ts':'script.ts','jsx':'component.jsx','tsx':'component.tsx','python':'script.py','py':'script.py','html':'index.html','css':'styles.css','json':'data.json','md':'README.md','yaml':'config.yml','yml':'config.yml'};
  return {path:map[String(lang||'').toLowerCase()]||'file.txt',explicit:false};
}

function isProbablyPartialSnippet(code){
  const c=String(code||'');
  if(/\ndiff --git\b/.test(c)||/^diff --git\b/m.test(c))return true;
  if(/^\s*@@\s+[-+]\d/m.test(c))return true;
  if(/^\s*\+\+\+\s|\n\+\+\+\s/.test(c)||/^\s*---\s|\n---\s/.test(c))return true;
  if(/^\s*\.\.\.\s*$/m.test(c))return true;
  if(/\b(insert|replace)\b.*\b(here|below)\b/i.test(c))return true;
  return false;
}

function normalizeClientPath(p){
  if(typeof p!=='string')return {ok:false,error:'Path must be a string'};
  let s=p.replace(/\\/g,'/').trim();
  if(s.startsWith('./'))s=s.slice(2);
  if(!s)return {ok:false,error:'Missing file path'};
  if(s.startsWith('/'))return {ok:false,error:'Path must be relative (no leading /)'};
  const parts=s.split('/');
  for(const part of parts){
    if(!part)return {ok:false,error:'Path contains empty segment'};
    if(part==='.'||part==='..')return {ok:false,error:'Path contains invalid segment'};
  }
  if(s.includes('/.git/')||s.startsWith('.git/'))return {ok:false,error:'Refusing to write into .git/'};
  return {ok:true,path:s};
}

function findLangFromCodeEl(codeEl){
  const cls=Array.from(codeEl.classList||[]);
  const langClass=cls.find(x=>x.startsWith('language-'));
  return langClass?langClass.replace('language-',''):'text';
}

function renderMarkdown(c){
  if(!c)return'';
  const raw=marked.parse(c);
  const temp=document.createElement('div');
  temp.innerHTML=raw;

  const codeEls=Array.from(temp.querySelectorAll('pre>code'));
  for(const codeEl of codeEls){
    const lang=findLangFromCodeEl(codeEl);
    const codeText=codeEl.textContent||'';
    const meta=extractFilePathMeta(codeText,lang);
    const uid='code-'+Math.random().toString(36).slice(2,11);
    codeEl.id=uid;
    codeEl.dataset.codeId=uid;

    const pre=codeEl.parentElement;
    const details=document.createElement('details');
    details.className='code-block';
    const summary=document.createElement('summary');
    summary.className='code-header';
    const label=meta.explicit?meta.path:`${meta.path} (guessed)`;

    summary.innerHTML=`
      <div class="code-left">
        <span class="code-caret">‚ñ∂</span>
        <span class="code-lang">${escapeHtml(label)}</span>
      </div>
      <div class="code-actions">
        <button type="button" data-action="copy" data-code-id="${uid}">Copy</button>
        <button type="button" class="apply-btn" data-action="patch" data-code-id="${uid}">Create PR</button>
      </div>
    `;
    const body=document.createElement('div');
    body.className='code-body';
    body.appendChild(pre);
    details.appendChild(summary);
    details.appendChild(body);
    pre.replaceWith(details);
  }

  return temp.innerHTML;
}

// Patch Preview / Create PR flow (event delegation, no inline handlers)
state.patchContext=null;

function openPatchModal(){ $('patchModal').classList.add('active'); }
function closePatchModal(){ $('patchModal').classList.remove('active'); state.patchContext=null; $('patchList').innerHTML=''; $('prTitle').value=''; $('prBody').value=''; $('allowPartialEdits').checked=false; }

$('closePatchModal').onclick=closePatchModal;
$('cancelPatch').onclick=closePatchModal;
$('patchModal').addEventListener('click',(e)=>{ if(e.target===$('patchModal')) closePatchModal(); });

function collectPatchesFromMessage(msgEl){
  const details=Array.from(msgEl.querySelectorAll('details.code-block'));
  return details.map((d,idx)=>{
    const codeEl=d.querySelector('code');
    const codeText=codeEl?codeEl.textContent:'';
    const lang=codeEl?findLangFromCodeEl(codeEl):'text';
    const meta=extractFilePathMeta(codeText,lang);
    return { idx, codeId: codeEl?.id, lang, codeText, suggestedPath: meta.path, explicitPath: meta.explicit, isPartial: isProbablyPartialSnippet(codeText) };
  });
}

function computeFileStatus(path){
  if(!state.repoFiles||!state.repoFiles.length) return 'unknown';
  return state.repoFiles.includes(path)?'modified':'added';
}

function renderPatchList(items){
  const repo=$('projectSelect').value;
  const rows=items.map((it,i)=>{
    const status=it.path?computeFileStatus(it.path):'unknown';
    const badgeCls=status==='added'?'added':status==='modified'?'modified':'unknown';
    const warns=[];
    if(!it.explicitPath)warns.push('Path guessed');
    if(it.isPartial)warns.push('Looks partial/diff');
    if(it.action==='delete')warns.push('Delete');
    if((it.content||'').length>200000)warns.push('Large file');
    const warnHtml=warns.length?`<div class="patch-warn">‚ö† ${warns.join(' ¬∑ ')}</div>`:'';
    return `
      <div class="patch-row" data-row="${i}">
        <input type="checkbox" data-field="enabled" ${it.enabled?'checked':''}>
        <select data-field="action">
          <option value="upsert" ${it.action==='upsert'?'selected':''}>Upsert</option>
          <option value="delete" ${it.action==='delete'?'selected':''}>Delete</option>
        </select>
        <div>
          <input type="text" data-field="path" value="${escapeHtml(it.path||'')}" placeholder="path/to/file.ext">
          ${warnHtml}
        </div>
        <span class="patch-badge ${badgeCls}">${status.toUpperCase()}</span>
      </div>
    `;
  }).join('');
  $('patchList').innerHTML=rows || `<div style="color:var(--text2);font-size:13px">No code blocks found to apply.</div>`;
}

async function openPatchPreviewFromButton(btn){
  const repo=$('projectSelect').value;
  if(!repo){showToast('Select a project first','error');return}
  if(!state.repoFiles||!state.repoFiles.length) await loadRepoFiles();

  const msgEl=btn.closest('.message.assistant');
  if(!msgEl){showToast('Could not locate message','error');return}
  const raw=collectPatchesFromMessage(msgEl);
  if(!raw.length){showToast('No code blocks found','error');return}

  const items=raw.map(r=>{
    const norm=normalizeClientPath(r.suggestedPath);
    const path=norm.ok?norm.path:'';
    return {
      enabled:true,
      action:'upsert',
      path,
      content:r.codeText,
      explicitPath:r.explicitPath,
      isPartial:r.isPartial,
      codeId:r.codeId
    };
  });

  state.patchContext={repo,items,conversationId:state.conversationId||null};
  $('prTitle').value=`AI changes (${state.conversationId||'adhoc'})`;
  $('prBody').value=`Draft PR created by AI Code Helper.\n\nConversation: ${state.conversationId||'adhoc'}\n`;
  renderPatchList(items);
  openPatchModal();
}

function syncPatchItemsFromUI(){
  const ctx=state.patchContext;if(!ctx)return;
  const rows=Array.from($('patchList').querySelectorAll('.patch-row'));
  rows.forEach((row)=>{
    const i=parseInt(row.dataset.row,10);
    const enabled=row.querySelector('[data-field="enabled"]').checked;
    const action=row.querySelector('[data-field="action"]').value;
    const path=row.querySelector('[data-field="path"]').value;
    ctx.items[i].enabled=enabled;
    ctx.items[i].action=action;
    ctx.items[i].path=path;
  });
}

async function createDraftPRFromPreview(){
  const ctx=state.patchContext;
  if(!ctx){showToast('No patch in progress','error');return}
  syncPatchItemsFromUI();

  const allowPartial=$('allowPartialEdits').checked;
  const selected=ctx.items.filter(x=>x.enabled);

  if(!selected.length){showToast('Select at least one file','error');return}

  for(const it of selected){
    const norm=normalizeClientPath(it.path||'');
    if(!norm.ok){showToast(`Invalid path: ${norm.error}`,'error');return}
    it.path=norm.path;
    if(!allowPartial && it.isPartial){
      showToast(`Refusing to apply partial/diff snippet: ${it.path}`,'error');return
    }
    if(it.action==='upsert' && !allowPartial){
      // Extra guardrail: refuse obviously empty "files"
      if(String(it.content||'').trim().length===0){
        showToast(`Refusing empty file content: ${it.path}`,'error');return
      }
    }
  }

  $('createPrBtn').disabled=true;$('createPrBtn').textContent='...';
  try{
    const payload={
      repoFullName:ctx.repo,
      conversationId:ctx.conversationId,
      title:$('prTitle').value||undefined,
      body:$('prBody').value||undefined,
      changes:selected.map(it=>({filePath:it.path,action:it.action,content:it.content,commitMessage:`${it.action==='delete'?'Delete':'Update'} ${it.path} via AI Code Helper`})),
    };
    const res=await fetch('/api/apply-pr',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const data=await res.json();
    if(!res.ok||data.error) throw new Error(data.error||`HTTP ${res.status}`);
    closePatchModal();
    showToast('Draft PR created!');
    if(data.prUrl) window.open(data.prUrl,'_blank');
  }catch(e){
    showToast('Failed: '+e.message,'error');
  }finally{
    $('createPrBtn').disabled=false;$('createPrBtn').textContent='Create Draft PR';
  }
}

$('createPrBtn').onclick=createDraftPRFromPreview;

document.addEventListener('click',(e)=>{
  const btn=e.target.closest('button[data-action]');
  if(!btn)return;
  const action=btn.dataset.action;
  if(action==='copy'){
    e.preventDefault();e.stopPropagation();
    const id=btn.dataset.codeId;
    const el=document.getElementById(id);
    if(el){navigator.clipboard.writeText(el.textContent||'');showToast('Copied!')}
  }
  if(action==='patch'){
    e.preventDefault();e.stopPropagation();
    openPatchPreviewFromButton(btn);
  }
});

$('modelToggle').querySelectorAll('button').forEach(b=>{b.onclick=()=>{$('modelToggle').querySelectorAll('button').forEach(x=>x.classList.remove('active'));b.classList.add('active');state.mode=b.dataset.mode;updateRoutePreview()}});

async function updateRoutePreview(){
  const m=$('messageInput').value;
  if(state.mode!=='auto'){const x=state.config?.models?.[state.mode];$('routePreview').textContent=x?`Using: ${x.displayName}`:'';return}
  if(!m.trim()){$('routePreview').textContent='Auto mode: Type to see which model';return}
  try{const r=await(await fetch('/api/preview-route',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:m,hasFiles:state.loadedFiles.length>0})})).json();$('routePreview').textContent=`Auto ‚Üí ${r.displayName}: ${r.reason}`}catch(e){$('routePreview').textContent='Auto mode'}
}

let pt;$('messageInput').addEventListener('input',()=>{$('messageInput').style.height='auto';$('messageInput').style.height=Math.min($('messageInput').scrollHeight,150)+'px';clearTimeout(pt);pt=setTimeout(updateRoutePreview,300)});

function startNewProject(){
  state.conversationId=null;
  state.loadedFiles=[];
  state.chatMode='planning';
  updateModeIndicator();
  $('chatTitle').textContent='New Project';
  $('projectSelect').value='';
  renderMessages([]);
  renderFileChips();
  renderConversations();
  $('messageInput').focus();
  closeSidebar();
}

function startNewChat(){
  state.conversationId=null;
  state.loadedFiles=[];
  state.chatMode='building';
  updateModeIndicator();
  $('chatTitle').textContent='New conversation';
  renderMessages([]);
  renderFileChips();
  renderConversations();
  $('messageInput').focus();
  closeSidebar();
}

$('newProjectBtn').onclick=startNewProject;
$('newChatBtn').onclick=startNewChat;
$('emptyNewProject').onclick=startNewProject;
$('emptySelectProject').onclick=()=>{openSidebar();$('projectSelect').focus()};

async function loadRepoFiles(){const r=$('projectSelect').value;if(!r){state.repoFiles=[];return}try{const[o,n]=r.split('/');const d=await(await fetch(`/api/projects/${o}/${n}/files`)).json();state.repoFiles=d.files||[]}catch(e){state.repoFiles=[]}}
$('projectSelect').onchange=async()=>{await loadRepoFiles();if($('projectSelect').value&&state.chatMode==='planning'){state.chatMode='building';updateModeIndicator()}};

$('attachBtn').onclick=()=>{if(!$('projectSelect').value){showToast('Select project first','error');return}state.selectedFiles=new Set(state.loadedFiles);renderFileTree();$('fileModal').classList.add('active')};

function renderFileTree(f=''){
  const fl=state.repoFiles.filter(x=>x.toLowerCase().includes(f.toLowerCase()));
  $('fileTree').innerHTML=fl.slice(0,100).map(x=>`<div class="file-item${state.selectedFiles.has(x)?' selected':''}" data-path="${x}">üìÑ ${x}</div>`).join('')+(fl.length>100?`<div style="padding:10px;color:var(--text3)">...${fl.length-100} more</div>`:'');
  $('fileTree').querySelectorAll('.file-item').forEach(e=>e.onclick=()=>{const p=e.dataset.path;if(state.selectedFiles.has(p)){state.selectedFiles.delete(p);e.classList.remove('selected')}else{state.selectedFiles.add(p);e.classList.add('selected')}});
}

$('fileSearch').oninput=e=>renderFileTree(e.target.value);
$('closeFileModal').onclick=$('cancelFiles').onclick=()=>$('fileModal').classList.remove('active');
$('confirmFiles').onclick=()=>{state.loadedFiles=Array.from(state.selectedFiles);renderFileChips();$('fileModal').classList.remove('active')};
$('fileModal').onclick=e=>{if(e.target===$('fileModal'))$('fileModal').classList.remove('active')};

function renderFileChips(){$('fileChips').innerHTML=state.loadedFiles.map(f=>`<div class="file-chip"><span>üìÑ ${f.split('/').pop()}</span><button onclick="removeFile('${f}')">√ó</button></div>`).join('')}
window.removeFile=p=>{state.loadedFiles=state.loadedFiles.filter(f=>f!==p);renderFileChips()};

async function sendMessage(){
  const m=$('messageInput').value.trim();if(!m||state.streaming)return;
  state.streaming=true;$('sendBtn').disabled=true;$('sendBtn').textContent='...';
  appendMessage('user',m);$('messageInput').value='';$('messageInput').style.height='auto';$('messages').scrollTop=$('messages').scrollHeight;
  const aMsg=appendMessage('assistant','');const cel=aMsg.querySelector('.msg-content');cel.innerHTML='<span class="streaming-dot"></span> Thinking...';
  try{
    const res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({conversationId:state.conversationId,message:m,repoFullName:$('projectSelect').value,loadedFiles:state.loadedFiles,modelOverride:state.mode,mode:state.chatMode})});
    const reader=res.body.getReader();const dec=new TextDecoder();let full='';
    while(true){const{done,value}=await reader.read();if(done)break;
      for(const line of dec.decode(value).split('\n')){if(!line.startsWith('data: '))continue;
        try{const d=JSON.parse(line.slice(6));
          if(d.type==='start'){state.conversationId=d.conversationId;$('modelIndicator').innerHTML=`<span class="dot"></span>${d.model}`}
          else if(d.type==='text'){full+=d.text;cel.innerHTML=renderMarkdown(full);$('messages').scrollTop=$('messages').scrollHeight}
          else if(d.type==='done'){
            if(d.cost){state.totalCost+=d.cost;$('costDisplay').textContent=`Session: $${state.totalCost.toFixed(4)}`}
            aMsg.querySelector('.msg-meta').textContent+=` ¬∑ ${d.model}`;
            if(d.projectCreated){
              showToast(`Project created: ${d.projectCreated.repoFullName}`);
              await loadProjects();
              $('projectSelect').value=d.projectCreated.repoFullName;
              await loadRepoFiles();
              state.chatMode='building';
              updateModeIndicator();
            }
            loadConversations();
          }
          else if(d.type==='error'){cel.innerHTML=`<p style="color:var(--red)">Error: ${d.error}</p>`}
        }catch(e){}}
    }
  }catch(e){cel.innerHTML=`<p style="color:var(--red)">Failed to send</p>`}
  finally{state.streaming=false;$('sendBtn').disabled=false;$('sendBtn').textContent='Send'}
}

$('sendBtn').onclick=sendMessage;
$('messageInput').onkeydown=e=>{if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){e.preventDefault();sendMessage()}};
document.querySelectorAll('.suggestion').forEach(s=>s.onclick=()=>{$('messageInput').value=s.dataset.text;$('messageInput').focus();updateRoutePreview()});

loadConfig();loadProjects();loadConversations();
</script>
</body>
</html>
